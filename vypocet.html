<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Výpočet půjčovného za náhradní vozidlo - Direct pojišťovna</title>
    <style>
        /* DirectSans Font Faces */
        @font-face {
            font-family: 'DirectSans';
            src: url('Písma/DirectSans-Regular.otf') format('opentype');
            font-weight: 400;
            font-style: normal;
        }

        @font-face {
            font-family: 'DirectSans';
            src: url('Písma/DirectSans-Italic.otf') format('opentype');
            font-weight: 400;
            font-style: italic;
        }

        @font-face {
            font-family: 'DirectSans';
            src: url('Písma/DirectSans-Medium.otf') format('opentype');
            font-weight: 500;
            font-style: normal;
        }

        @font-face {
            font-family: 'DirectSans';
            src: url('Písma/DirectSans-MediumItalic.otf') format('opentype');
            font-weight: 500;
            font-style: italic;
        }

        @font-face {
            font-family: 'DirectSans';
            src: url('Písma/DirectSans-Semibold.otf') format('opentype');
            font-weight: 600;
            font-style: normal;
        }

        @font-face {
            font-family: 'DirectSans';
            src: url('Písma/DirectSans-SemiboldItalic.otf') format('opentype');
            font-weight: 600;
            font-style: italic;
        }

        @font-face {
            font-family: 'DirectSans';
            src: url('Písma/DirectSans-Bold.otf') format('opentype');
            font-weight: 700;
            font-style: normal;
        }

        @font-face {
            font-family: 'DirectSans';
            src: url('Písma/DirectSans-BoldItalic.otf') format('opentype');
            font-weight: 700;
            font-style: italic;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DirectSans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            font-weight: 400;
        }

        /* Header */
        .header {
            background-color: #ffffff;
            padding: 0 40px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-radius: 0 0 20px 20px;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 50px;
            height: 80px;
        }

        .logo {
            display: flex;
            align-items: center;
            text-decoration: none;
        }

        .logo img {
            height: 65px;
            width: auto;
        }

        .header-nav {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .nav-link {
            font-family: 'DirectSans', sans-serif;
            color: #1a4d3a;
            text-decoration: none;
            font-size: 16px;
            font-weight: 500;
            padding: 10px 20px;
            position: relative;
            transition: all 0.3s ease;
            border-radius: 8px;
        }

        .nav-link::after {
            display: none;
        }

        .nav-link.active {
            color: #004033;
            background-color: #cbdc4d;
            font-weight: 600;
            border-radius: 8px;
        }

        .nav-link:not(.active):hover {
            color: #004033;
        }

        .nav-link.active:hover {
            background-color: #b8c93f;
            color: #004033;
        }

        /* Main Content */
        .main-content {
            max-width: 1000px;
            margin: 40px auto;
            padding: 0 40px;
        }

        .form-container {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .page-title {
            font-family: 'DirectSans', sans-serif;
            font-size: 28px;
            font-weight: 700;
            color: #1a4d3a;
            margin-bottom: 30px;
            text-align: center;
        }

        .form-section {
            margin-bottom: 30px;
        }

        /* Visual separation between damaged vehicle category section and rental vehicle section */
        #damagedVehicleCategorySection + .form-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #e6e6e6;
        }

        .section-title {
            font-family: 'DirectSans', sans-serif;
            font-size: 18px;
            font-weight: 600;
            color: #1a4d3a;
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-family: 'DirectSans', sans-serif;
            font-size: 14px;
            font-weight: 500;
            color: #555;
            margin-bottom: 8px;
        }

        .form-group label .required {
            color: #e74c3c;
        }

        .form-group {
            position: relative;
        }

        .form-group input,
        .form-group select {
            font-family: 'DirectSans', sans-serif;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 400;
            transition: all 0.3s;
            background-color: #fff;
            width: 100%;
        }

        .form-group input:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #fff;
            border: 2px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .autocomplete-dropdown.show {
            display: block;
        }

        .autocomplete-item {
            padding: 12px 15px;
            cursor: pointer;
            font-family: 'DirectSans', sans-serif;
            font-size: 16px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background-color: #cbdc4d;
            color: #004033;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #cbdc4d;
            box-shadow: 0 0 0 3px rgba(203, 220, 77, 0.2);
        }

        .date-input-wrapper {
            position: relative;
        }

        .date-input-wrapper input {
            padding-right: 40px;
        }

        .date-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #999;
        }

        /* Category Content Container */
        #damagedVehicleCategoryContent {
            display: flex;
            flex-direction: column;
        }

        /* Category Info Section */
        .category-info {
            margin-bottom: 20px;
        }

        .category-name {
            font-size: 18px;
            font-weight: 600;
            color: #004033;
            margin-bottom: 10px;
            background-color: rgba(203, 220, 77, 0.15);
            border-bottom: 2px solid #cbdc4d;
            padding: 8px 12px;
            padding-bottom: 5px;
            border-radius: 4px;
            display: inline-block;
        }

        .category-note {
            font-size: 14px;
            color: #666;
            font-style: italic;
            margin-top: 5px;
        }

        .category-rates {
            background-color: rgba(203, 220, 77, 0.10);
            border-bottom: 2px solid #cbdc4d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 0;
            margin-top: 0;
        }

        .rate-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .rate-item:last-child {
            border-bottom: none;
        }

        .rate-label {
            font-size: 16px;
            color: #333;
        }

        .rate-value {
            font-size: 18px;
            font-weight: 600;
            color: #004033;
        }

        .category-models {
            margin-top: 0;
            margin-bottom: 0;
            padding-top: 24px;
            border-top: 1px solid #e6e6e6;
        }

        .models-title {
            font-size: 18px;
            font-weight: 600;
            color: #004033;
            margin-bottom: 15px;
        }

        .models-table-container {
            overflow-x: auto;
        }

        .models-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'DirectSans', sans-serif;
            border-radius: 8px;
            overflow: hidden;
        }

        .models-table thead {
            background-color: #cbdc4d;
            border-radius: 8px 8px 0 0;
        }

        .models-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #004033;
            border-bottom: 2px solid #004033;
            white-space: nowrap;
            position: relative;
        }

        /* Subtle divider lines in header - not full width */
        .models-table th:not(:first-child)::before {
            content: '';
            position: absolute;
            left: 0;
            top: 15%;
            bottom: 15%;
            width: 1px;
            background-color: #004033;
            opacity: 0.2;
        }

        .models-table th:first-child {
            border-radius: 8px 0 0 0;
        }

        .models-table th:last-child {
            border-radius: 0 8px 0 0;
        }

        .models-table th:nth-child(2),
        .models-table th:nth-child(3) {
            text-align: right;
        }

        .models-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
        }

        /* Subtle divider lines - not full width, elegant spacing */
        .models-table tbody tr td:not(:first-child)::before {
            content: '';
            position: absolute;
            left: 0;
            top: 20%;
            bottom: 20%;
            width: 1px;
            background-color: #cbdc4d;
            opacity: 0.4;
        }

        .models-table td:nth-child(2),
        .models-table td:nth-child(3) {
            text-align: right;
        }

        .models-table td strong {
            font-weight: 600;
            color: #004033;
        }

        .models-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .models-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Results */
        .results-section {
            background-color: rgba(203, 220, 77, 0.15);
            border-bottom: 2px solid #cbdc4d;
            border-radius: 8px;
            padding: 25px;
            margin: 30px 0;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .result-row:last-child {
            border-bottom: none;
        }

        .result-label-wrapper {
            flex: 1;
        }

        .result-label {
            font-family: 'DirectSans', sans-serif;
            font-size: 16px;
            font-weight: 400;
            color: #555;
        }

        .result-value-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            text-align: right;
        }

        .result-value {
            font-family: 'DirectSans', sans-serif;
            font-size: 18px;
            font-weight: 600;
            color: #1a4d3a;
        }

        .result-note {
            font-family: 'DirectSans', sans-serif;
            font-size: 12px;
            font-weight: 400;
            color: #666;
            font-style: italic;
            margin-top: 4px;
        }

        .btn-calculate {
            font-family: 'DirectSans', sans-serif;
            background-color: #cbdc4d;
            color: #004033;
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            width: 100%;
            margin-top: 20px;
        }

        .btn-calculate:hover {
            background-color: #b8c93f;
        }

        .btn-print {
            font-family: 'DirectSans', sans-serif;
            background-color: #004033;
            color: #ffffff;
            padding: 11.2px 24px;
            border: none;
            border-radius: 8px;
            font-size: 12.8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-print:hover {
            background-color: #003025;
        }

        .btn-reset {
            font-family: 'DirectSans', sans-serif;
            background-color: #ffffff;
            color: #004033;
            padding: 11.2px 24px;
            border: 2px solid #004033;
            border-radius: 8px;
            font-size: 12.8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-reset:hover {
            background-color: #f0f0f0;
            border-color: #003025;
        }

        /* Hide print footer elements on screen */
        .print-date {
            display: none !important;
            visibility: hidden !important;
            position: absolute !important;
            left: -9999px !important;
        }
        
        .print-footer-contact {
            display: none !important;
            visibility: hidden !important;
            position: absolute !important;
            left: -9999px !important;
        }
        
        /* Print styles are defined in @media print section below */
        
        .footer-text {
            font-family: 'DirectSans', sans-serif;
            font-size: 12px;
            font-weight: 400;
            color: #999;
            line-height: 1.6;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 0 20px;
            }

            .header-content {
                height: 70px;
                gap: 20px;
            }

            .logo img {
                height: 52px;
            }

            .header-nav {
                gap: 15px;
            }

            .nav-link {
                font-size: 14px;
            }

            .main-content {
                padding: 0 20px;
                margin: 20px auto;
            }

            .form-container {
                padding: 25px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }

         /* Print Styles */
         @media print {
             /* Print header with logo */
             @page {
                 margin-top: 15mm;
                 margin-bottom: 25mm;
                 margin-left: 20mm;
                 margin-right: 20mm;
             }
             
             /* Force print footer elements to be visible */
             .print-date,
             .print-footer-contact {
                 display: block !important;
                 visibility: visible !important;
                 position: fixed !important;
             }
             
             /* Adjust margins for pages */
             @page:not(:last) {
                 margin-bottom: 20mm;
             }
             
             @page:last {
                 margin-bottom: 25mm;
             }
             
             /* Ensure content aligns to left margin (red line) */
             .main-content {
                 padding-left: 0 !important;
                 padding-right: 0 !important;
             }
             
             /* Hide elements that shouldn't be printed */
             .header,
             .nav-link,
             .btn-calculate,
             .btn-print,
             .btn-reset,
             .autocomplete-dropdown,
             .date-icon {
                 display: none !important;
             }
             
             /* Ensure print footer contact is visible in print */
             .print-footer-contact[style*="display: none"] {
                 display: block !important;
             }
             
             /* Override any inline styles for print footer contact */
             .print-footer-contact[style],
             .print-footer-contact {
                 display: block !important;
                 visibility: visible !important;
                 position: fixed !important;
                 left: auto !important;
                 right: 20mm !important;
                 bottom: 10mm !important;
             }
             
             /* Show footer text in print - moved higher on second page */
             .footer-text {
                 display: block !important;
                 margin-top: 16mm;
                 padding-top: 8mm;
                 padding-bottom: 20mm;
                 border-top: 1px solid #e6e6e6;
                 font-size: 9pt;
                 line-height: 1.5;
                 color: #666;
                 page-break-inside: avoid;
                 position: relative;
             }
             
             /* Print footer with contact info - bottom right corner, shown after footer-text (last page) */
             /* Hidden by default, shown only after footer-text in print */
             .print-footer-contact {
                 display: block !important;
                 visibility: visible !important;
                 position: fixed !important;
                 bottom: 10mm !important;
                 right: 20mm !important;
                 font-size: 9pt !important;
                 color: #666 !important;
                 text-align: right !important;
                 z-index: 1000 !important;
                 padding: 0 !important;
                 margin: 0 !important;
                 opacity: 1 !important;
                 white-space: nowrap !important;
                 left: auto !important;
             }
             
             /* Ensure both footer elements are always visible in print */
             body::after {
                 content: '';
                 display: none;
             }
             
             /* Override inline style for print date */
             .print-date[style],
             .print-date {
                 display: block !important;
                 visibility: visible !important;
                 position: fixed !important;
                 left: 20mm !important;
                 bottom: 10mm !important;
             }

             /* Hide form sections except first one (damaged vehicle) and category section */
             .form-section {
                 display: none !important;
             }

             /* Show first form section (damaged vehicle info) */
             .form-section:first-of-type {
                 display: block !important;
             }

             /* Show damaged vehicle category section */
             #damagedVehicleCategorySection {
                 display: block !important;
             }

             /* Hide "Pronajímané vozidlo" section by default in print */
             .form-section:nth-of-type(3) {
                 display: none !important;
             }
             
             /* Show "Pronajímané vozidlo" section in print when results are visible */
             /* Using a class-based approach for better browser compatibility */
             .form-section:nth-of-type(3).show-in-print {
                 display: block !important;
                 margin-top: 12mm;
                 margin-bottom: 12mm;
                 page-break-after: avoid;
             }
             
             .form-section:nth-of-type(3).show-in-print .section-title {
                 font-size: 14pt;
                 font-weight: 600;
                 color: #1a4d3a;
                 margin-bottom: 4mm;
             }
             
             .form-section:nth-of-type(3).show-in-print .form-row {
                 display: grid;
                 grid-template-columns: repeat(3, 1fr);
                 gap: 15px;
                 margin-bottom: 0;
             }
             
             .form-section:nth-of-type(3).show-in-print .form-group {
                 margin-bottom: 0;
             }
             
             .form-section:nth-of-type(3).show-in-print .form-group label {
                 font-size: 10pt;
                 font-weight: 500;
                 color: #555;
                 margin-bottom: 3px;
             }
             
             .form-section:nth-of-type(3).show-in-print .form-group input {
                 font-size: 11pt;
                 padding: 6px 10px;
                 border: 1px solid #ccc;
                 background-color: #fff;
                 color: #333;
                 pointer-events: none;
                 border-radius: 6px;
             }
             
             .form-section:nth-of-type(3).show-in-print #actionButtonsContainer {
                 display: none !important;
             }
             
             #actionButtonsContainer {
                 display: none !important;
             }

             /* Reset body and page */
             body {
                 background-color: #ffffff;
                 color: #333;
                 font-size: 11pt;
                 line-height: 1.4;
                 font-family: 'DirectSans', sans-serif;
             }

             .main-content {
                 max-width: 100%;
                 margin: 0;
                 padding: 5mm 0 15mm 0;
                 padding-left: 0 !important;
                 padding-right: 0 !important;
                 box-shadow: none;
                 background-color: #ffffff;
             }
             
             /* Print logo header - aligned to left margin (red line) */
             .print-logo-header {
                 display: block !important;
                 position: absolute;
                 top: 0;
                 left: 0;
                 width: auto;
                 height: auto;
                 padding: 0;
                 background-color: transparent;
                 z-index: 1000;
                 page-break-after: avoid;
                 margin: 0 0 1.5rem 0;
                 border: none;
                 text-align: left;
             }
             
             .print-logo-header img {
                 height: 18mm;
                 width: auto;
                 max-width: 60mm;
                 display: block;
                 margin: 0;
             }
             
             /* Add top margin to first page content to make room for logo */
             .main-content {
                 padding-top: 25mm !important;
                 position: relative;
             }
             
             /* Ensure logo doesn't interfere with content */
             .form-container {
                 margin-top: 0;
             }

             .form-container {
                 background-color: #ffffff;
                 padding: 0;
                 padding-left: 0 !important;
                 padding-right: 0 !important;
                 box-shadow: none;
                 border-radius: 0;
                 max-width: 100%;
             }

             /* Print title */
             .page-title {
                 font-size: 22pt;
                 font-weight: 700;
                 color: #1a4d3a;
                 margin-top: 1.5rem;
                 margin-bottom: 12mm;
                 text-align: left;
                 page-break-after: avoid;
             }

             /* Show form section with damaged vehicle info */
             .form-section:first-of-type {
                 display: block !important;
                 margin-bottom: 12mm;
                 page-break-after: avoid;
             }

             .form-section:first-of-type .section-title {
                 font-size: 14pt;
                 font-weight: 600;
                 color: #1a4d3a;
                 margin-top: 0;
                 margin-bottom: 6mm;
             }

             .form-section:first-of-type .form-row {
                 display: grid;
                 grid-template-columns: repeat(3, 1fr);
                 gap: 15px;
                 margin-bottom: 0;
             }

             .form-section:first-of-type .form-group {
                 margin-bottom: 0;
             }

             .form-section:first-of-type .form-group label {
                 font-size: 10pt;
                 font-weight: 500;
                 color: #555;
                 margin-bottom: 3px;
             }

             .form-section:first-of-type .form-group input {
                 font-size: 11pt;
                 padding: 6px 10px;
                 border: 1px solid #ccc;
                 background-color: #fff;
                 color: #333;
                 pointer-events: none;
                 border-radius: 6px;
             }

             /* Print section for damaged vehicle category */
             #damagedVehicleCategorySection {
                 display: block !important;
                 page-break-inside: avoid;
                 margin-top: 12mm;
                 margin-bottom: 12mm;
                 padding: 0;
                 background-color: #ffffff;
                 border: none;
             }

             #damagedVehicleCategorySection .section-title {
                 font-size: 14pt;
                 font-weight: 600;
                 color: #1a4d3a;
                 margin-bottom: 6mm;
                 page-break-after: avoid;
                 line-height: 1.3;
             }

             .category-info {
                 margin-bottom: 6mm;
                 background-color: #ffffff;
                 padding: 0;
                 border-radius: 0;
                 box-shadow: none;
             }

             .category-name {
                 font-size: 14pt;
                 font-weight: 600;
                 color: #004033;
                 margin-bottom: 4mm;
             }

             .category-note {
                 font-size: 10pt;
                 color: #666;
                 font-style: italic;
                 margin-top: 2mm;
             }

             .category-rates {
                 background-color: rgba(203, 220, 77, 0.10) !important;
                 border-bottom: 2px solid #cbdc4d !important;
                 border-radius: 6px;
                 padding: 12px;
                 margin-top: 4mm;
                 margin-bottom: 10mm;
                 -webkit-print-color-adjust: exact;
                 print-color-adjust: exact;
             }

             .rate-item {
                 display: flex;
                 justify-content: space-between;
                 align-items: center;
                 padding: 6px 0;
                 border-bottom: 1px solid #e0e0e0;
             }

             .rate-item:last-child {
                 border-bottom: none;
             }

             .rate-label {
                 font-size: 11pt;
                 color: #333;
             }

             .rate-value {
                 font-size: 13pt;
                 font-weight: 600;
                 color: #004033;
             }

             /* Models table in print */
             .category-models {
                 margin-top: 8mm;
                 display: block !important;
             }

             .models-title {
                 font-size: 13pt;
                 font-weight: 600;
                 color: #004033;
                 margin-top: 10mm;
                 margin-bottom: 5mm;
             }

             .models-table-container {
                 display: block !important;
                 overflow: visible;
             }

             .models-table {
                 width: 100%;
                 border-collapse: collapse;
                 font-family: 'DirectSans', sans-serif;
                 margin-bottom: 8mm;
                 border-radius: 6px;
                 overflow: hidden;
             }

             .models-table thead {
                 background-color: #cbdc4d !important;
                 -webkit-print-color-adjust: exact;
                 print-color-adjust: exact;
             }

             .models-table th {
                 padding: 8px 10px;
                 text-align: left;
                 font-weight: 600;
                 color: #004033 !important;
                 -webkit-print-color-adjust: exact;
                 print-color-adjust: exact;
                 border-bottom: 2px solid #004033;
                 font-size: 10pt;
             }

             .models-table th:first-child {
                 border-radius: 6px 0 0 0;
             }

             .models-table th:last-child {
                 border-radius: 0 6px 0 0;
             }

             .models-table th:nth-child(2),
             .models-table th:nth-child(3) {
                 text-align: right;
             }

             .models-table td {
                 padding: 6px 10px;
                 border-bottom: 1px solid #e0e0e0;
                 font-size: 10pt;
                 color: #333;
                 line-height: 1.4;
             }

             .models-table td:nth-child(2),
             .models-table td:nth-child(3) {
                 text-align: right;
                 color: #004033;
                 font-weight: 600;
             }

             .models-table td strong {
                 font-weight: 600;
                 color: #004033;
             }

             .models-table tbody tr:last-child td {
                 border-bottom: none;
             }

             /* Print results section - only show if it's visible on screen (has actual values) */
             .results-section[style*="display: none"] {
                 display: none !important;
             }

             .results-section:not([style*="display: none"]) {
                 display: block !important;
                 page-break-inside: avoid;
                 margin-top: 12mm;
                 margin-bottom: 12mm;
                 padding: 12px;
                 background-color: rgba(203, 220, 77, 0.15) !important;
                 border-bottom: 2px solid #cbdc4d !important;
                 border-radius: 6px;
                 -webkit-print-color-adjust: exact;
                 print-color-adjust: exact;
             }

             .result-row {
                 display: flex;
                 justify-content: space-between;
                 align-items: flex-start;
                 padding: 6px 0;
                 border-bottom: 1px solid #e0e0e0;
                 page-break-inside: avoid;
             }

             .result-row:last-child {
                 border-bottom: none;
             }

             .result-label {
                 font-size: 11pt;
                 color: #555;
             }

             .result-value {
                 font-size: 13pt;
                 font-weight: 600;
                 color: #1a4d3a;
             }

             .result-note {
                 font-size: 10pt;
                 color: #666;
                 font-style: italic;
                 margin-top: 2px;
             }

             /* Print date - bottom left corner, positioned at bottom of page */
             /* Override screen styles to show in print */
             .print-date {
                 display: block !important;
                 visibility: visible !important;
                 position: fixed !important;
                 bottom: 10mm !important;
                 left: 20mm !important;
                 text-align: left !important;
                 font-size: 9pt !important;
                 color: #666 !important;
                 z-index: 1000 !important;
                 margin: 0 !important;
                 padding: 0 !important;
                 border: none !important;
                 white-space: nowrap !important;
             }
             
             /* Footer text - ensure it's on last page */
             .footer-text {
                 position: relative;
                 margin-bottom: 0;
                 padding-bottom: 0;
                 page-break-inside: avoid;
                 margin-top: 16mm;
                 padding-top: 8mm;
                 border-top: 1px solid #e6e6e6;
             }

             /* Hide print vehicle info - we use the actual form sections */
             .print-vehicle-info {
                 display: none !important;
             }

             /* Avoid page breaks */
             .results-section,
             #damagedVehicleCategorySection,
             .form-section:first-of-type {
                 page-break-inside: avoid;
             }

             /* Keep some styling for print */
             * {
                 box-shadow: none !important;
             }

             /* Ensure colors print correctly */
             * {
                 -webkit-print-color-adjust: exact;
                 print-color-adjust: exact;
             }
         }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="index.html" class="logo">
                <img src="Loga/Logo+pozitivní+RGB.png" alt="Direct pojišťovna">
            </a>
            <nav class="header-nav">
                <a href="index.html" class="nav-link">Ceník vozidel</a>
                <a href="vypocet.html" class="nav-link active">Výpočet půjčovného</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="form-container">
            <h1 class="page-title">Výpočet půjčovného za náhradní vozidlo</h1>

            <form id="calculationForm">
                <!-- Poškozené vozidlo -->
                <div class="form-section">
                    <h2 class="section-title">Poškozené vozidlo</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Rok uvedení do provozu <span class="required">*</span></label>
                            <input type="text" id="rokProvozu" placeholder="Vyberte rok" autocomplete="off" required>
                            <div class="autocomplete-dropdown" id="rokProvozuDropdown"></div>
                        </div>
                        <div class="form-group">
                            <label>Značka</label>
                            <input type="text" id="znackaPoskozene" placeholder="Vyberte značku" autocomplete="off">
                            <div class="autocomplete-dropdown" id="znackaPoskozeneDropdown"></div>
                        </div>
                        <div class="form-group">
                            <label>Model</label>
                            <input type="text" id="modelPoskozene" placeholder="Vyberte model" autocomplete="off">
                            <div class="autocomplete-dropdown" id="modelPoskozeneDropdown"></div>
                        </div>
                    </div>
                </div>

                <!-- Mezikrok - Nárokovaná kategorie poškozeného vozidla -->
                <div class="form-section" id="damagedVehicleCategorySection" style="display: none;">
                    <h2 class="section-title">Na základě zadaných údajů máte nárok na zapůjčení vozidla této třídy.</h2>
                    <div id="damagedVehicleCategoryContent">
                        <div class="category-info">
                            <div class="category-name" id="damagedCategoryName"></div>
                            <div class="category-note" id="damagedCategoryNote"></div>
                        </div>
                        <div class="category-rates">
                            <div class="rate-item">
                                <span class="rate-label">Sazba za pronájem 1-10 dní:</span>
                                <span class="rate-value" id="damagedRate1_10"></span>
                            </div>
                            <div class="rate-item">
                                <span class="rate-label">Sazba za pronájem 11-30 dní:</span>
                                <span class="rate-value" id="damagedRate11_30"></span>
                            </div>
                        </div>
                        <div class="category-models">
                            <h3 class="models-title">Modely v této kategorii:</h3>
                            <div class="models-table-container">
                                <table class="models-table" id="damagedCategoryModelsTable">
                                    <thead>
                                        <tr>
                                            <th>Značka a model vozidla</th>
                                            <th>1-10 dní (Kč bez DPH)</th>
                                            <th>11-30 dní (Kč bez DPH)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="damagedCategoryModelsBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Buttons moved to below "Přepočítat" button -->
                </div>

                <!-- Pronajímané vozidlo -->
                <div class="form-section">
                    <h2 class="section-title">Pronajímané vozidlo</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Rok uvedení do provozu</label>
                            <input type="text" id="rokProvozuPronajmene" placeholder="Vyberte rok" autocomplete="off">
                            <div class="autocomplete-dropdown" id="rokProvozuPronajmeneDropdown"></div>
                        </div>
                        <div class="form-group">
                            <label>Značka</label>
                            <input type="text" id="znackaPronajmene" placeholder="Vyberte značku" autocomplete="off">
                            <div class="autocomplete-dropdown" id="znackaPronajmeneDropdown"></div>
                        </div>
                        <div class="form-group">
                            <label>Model</label>
                            <input type="text" id="modelPronajmene" placeholder="Vyberte model" autocomplete="off">
                            <div class="autocomplete-dropdown" id="modelPronajmeneDropdown"></div>
                        </div>
                    </div>
                    
                    <!-- Buttons moved to below "Přepočítat" button -->
                </div>

                <!-- Results -->
                <div class="results-section" id="resultsSection" style="display: none;">
                    <div class="result-row">
                        <div class="result-label-wrapper">
                            <span class="result-label">Náhrada za 1 den za pronájem 1-10 dní</span>
                        </div>
                        <div class="result-value-wrapper">
                            <span class="result-value" id="cenaDo14">-</span>
                            <span class="result-note" id="noteDo14"></span>
                        </div>
                    </div>
                    <div class="result-row">
                        <div class="result-label-wrapper">
                            <span class="result-label">Náhrada za 1 den za pronájem 11-30 dní</span>
                        </div>
                        <div class="result-value-wrapper">
                            <span class="result-value" id="cenaNad14">-</span>
                            <span class="result-note" id="noteNad14"></span>
                        </div>
                    </div>
                </div>
                
                <button type="button" class="btn-calculate" id="calculateBtn">Přepočítat</button>
                
                <!-- Print and Reset Buttons (shown dynamically based on form state) -->
                <div id="actionButtonsContainer" style="margin-top: 30px; display: none; gap: 15px; justify-content: center; align-items: center; flex-direction: row;">
                    <button type="button" class="btn-print" id="printBtn" onclick="window.print()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; vertical-align: middle;">
                            <polyline points="6 9 6 2 18 2 18 9"></polyline>
                            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                            <rect x="6" y="14" width="12" height="8"></rect>
                        </svg>
                        Tisk do PDF
                    </button>
                    <button type="button" class="btn-reset" id="resetBtn" onclick="resetCalculation()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; vertical-align: middle;">
                            <polyline points="23 4 23 10 17 10"></polyline>
                            <polyline points="1 20 1 14 7 14"></polyline>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                        Nový výpočet
                    </button>
                </div>
            </form>
            
            <!-- Print Logo Header (hidden on screen, visible in print) -->
            <div class="print-logo-header" style="display: none;">
                <img src="Loga/Logo+pozitivní+RGB.png" alt="Direct pojišťovna">
            </div>

            <div class="footer-text">
                <h3 style="font-family: 'DirectSans', sans-serif; font-size: 14px; font-weight: 600; color: #666; margin-bottom: 10px; margin-top: 0;">Doplňující informace</h3>
                Všechny denní sazby jsou bez odpočtu pevných nákladů (z této částky už tedy nebudeme odečítat náklady za opotřebení poškozeného vozidla).<br>
                Ceny nezahrnují pohonné hmoty a případnou spoluúčast za poškození vozidla.<br>
                Pokud je vaše poškozené auto starší než 8 let, sazba za půjčení náhradního auta se o jednu třídu sníží.<br>
                Cenu půjčovného nad 30 dní je nutné konzultovat s likvidátorem dané škodní události.
            </div>
            
            <!-- Print Date (hidden on screen, visible in print - only on last page) -->
            <div class="print-date">
                Datum výpočtu: <span id="printDate"></span>
            </div>
            
            <!-- Print Footer Contact (hidden on screen, visible in print - only on last page) -->
            <div class="print-footer-contact">
                www.direct.cz | info@direct.cz
            </div>
        </div>
    </main>

    <script>
        // Data from price list
        const cenÝkData = [
          {
            "kategorie": "vozy Škoda",
            "znacka_typ": "Citigo",
            "cena_1_10_dni": 500,
            "cena_11_30_dni": 400
          },
          {
            "kategorie": "vozy Škoda",
            "znacka_typ": "Fabia + Roomster",
            "cena_1_10_dni": 600,
            "cena_11_30_dni": 480
          },
          {
            "kategorie": "vozy Škoda",
            "znacka_typ": "Rapid",
            "cena_1_10_dni": 650,
            "cena_11_30_dni": 520
          },
          {
            "kategorie": "vozy Škoda",
            "znacka_typ": "Scala + Kamiq + Yeti",
            "cena_1_10_dni": 750,
            "cena_11_30_dni": 600
          },
          {
            "kategorie": "vozy Škoda",
            "znacka_typ": "Octavia I + II",
            "cena_1_10_dni": 600,
            "cena_11_30_dni": 480
          },
          {
            "kategorie": "vozy Škoda",
            "znacka_typ": "Octavia III + IV",
            "cena_1_10_dni": 1000,
            "cena_11_30_dni": 800
          },
          {
            "kategorie": "vozy Škoda",
            "znacka_typ": "Karoq + Elroq",
            "cena_1_10_dni": 1100,
            "cena_11_30_dni": 880
          },
          {
            "kategorie": "vozy Škoda",
            "znacka_typ": "Superb",
            "cena_1_10_dni": 1200,
            "cena_11_30_dni": 960
          },
          {
            "kategorie": "vozy Škoda",
            "znacka_typ": "Kodiaq + Enyaq",
            "cena_1_10_dni": 1350,
            "cena_11_30_dni": 1080
          },
          {
            "kategorie": "Mini",
            "znacka_typ": "Citroën C1, Fiat 500 + Panda, Ford KA, Hyundai i10, Chevrolet Spark, Kia Picanto, Opel Adam + Agila, Peugeot 107 + 108, Renault Twingo, Seat Mii, Smart Fortwo, Suzuki Alto + Celerio + Splash, Toyota Aygo, Volkswagen UP!",
            "cena_1_10_dni": 550,
            "cena_11_30_dni": 440
          },
          {
            "kategorie": "Malá ",
            "znacka_typ": "Alfa Romeo MiTo, Citroën C3, DS 3, Fiat Punto, Ford Fiesta + Fusion, Honda Jazz, Hyundai i20 + Getz, Chevrolet Aveo + Kalos, Kia Rio + Soul, Mazda 2, Mitsubishi Colt, Nissan Micra, Opel Corsa, Peugeot 206 + 207 + 208, Renault Clio + Thalia, Seat Cordoba + Ibiza, Subaru Justy, Smart ForFour, Suzuki Swift, Toyota Yaris, Volkswagen Polo, Dacia Sandero + Logan",
            "cena_1_10_dni": 700,
            "cena_11_30_dni": 560
          },
          {
            "kategorie": "Malá premium",
            "znacka_typ": "Audi A1, Mini Cooper",
            "cena_1_10_dni": 900,
            "cena_11_30_dni": 720
          },
          {
            "kategorie": "Nižší střední",
            "znacka_typ": "Alfa Romeo 147 + Giulietta, Fiat Bravo +Tipo, Citroën C4 + C-Elysée, Cupra Leon, DS 4, Ford Focus, Honda Civic, Hyundai Accent + Elantra + i30, Chevrolet Cruze, Kia Ceed, Mazda 3, Mitsubishi Lancer, Nissan Almera, Opel Astra, Peugeot 301 + 307 + 308, Renault Megane + Fluence, Seat Leon + Toledo, Subaru Impreza, Toyota Auris + Corolla + Prius, Volvo C30 + V40, Volkswagen Golf + New Beetle",
            "cena_1_10_dni": 900,
            "cena_11_30_dni": 720
          },
          {
            "kategorie": "Nižší střední premium",
            "znacka_typ": "Audi A3, BMW 1 + 2, Mercedes Benz A, Lexus CT, Mini Clubman",
            "cena_1_10_dni": 1200,
            "cena_11_30_dni": 960
          },
          {
            "kategorie": "Střední",
            "znacka_typ": "Alfa Romeo 159 + Giulia, Citroën C5, Dodge Caliber, Fiat Croma, Ford Mondeo, Hyundai i40 + Sonata, Kia Optima,\nMazda 6, Opel Insignia + Vectra, Peugeot 406 + 407 + 508, Renault Talisman + Laguna, Seat Exeo, Subaru Legacy + Levorg, Toyota Avensis + Camry, Volkswagen Passat + CC, Tesla Model 3",
            "cena_1_10_dni": 1200,
            "cena_11_30_dni": 960
          },
          {
            "kategorie": "Střední premium",
            "znacka_typ": "Audi A4 + A5, BMW 3 + 4, Jaguar XE, Mercedes-Benz C + CLA, Lexus IS, Volvo S60 + V60 + V70, Hyundai IONIQ 5+6",
            "cena_1_10_dni": 1500,
            "cena_11_30_dni": 1200
          },
          {
            "kategorie": "Vyšší střední",
            "znacka_typ": "Citroën C6, DS 9, Honda Legend, Hyundai Genesis, Peugeot 607,",
            "cena_1_10_dni": 1500,
            "cena_11_30_dni": 1200
          },
          {
            "kategorie": "Vyšší střední premium",
            "znacka_typ": "Audi A6 + A7, BMW 5 + 6, Jaguar XF, Maserati Ghibli, Mercedes-Benz E + CLS, Volvo S90 + V90, Volkswagen Arteon,",
            "cena_1_10_dni": 2100,
            "cena_11_30_dni": 1680
          },
          {
            "kategorie": "Luxusní",
            "znacka_typ": "Audi A8, BMW 7 + 8, Jaguar XJ + XK, Lexus LS, Mercedes Benz S, Porsche Panamera, Volkswagen Phaeton, Tesla Model S",
            "cena_1_10_dni": 2800,
            "cena_11_30_dni": 2240
          },
          {
            "kategorie": "MPV malá",
            "znacka_typ": "Citroën C3 Picasso, Fiat 500L + Qubo, Ford B-MAX + C-MAX, Hyundai ix20, Kia Venga, Opel Meriva, Renault Kangoo, Toyota Urban Cruiser + Verso, Dacia Jogger + Logan MCV,",
            "cena_1_10_dni": 800,
            "cena_11_30_dni": 640
          },
          {
            "kategorie": "MPV střední",
            "znacka_typ": "Citroën C4 SpaceTourer + Grand Picasso + C4 Picasso + Xsara Picasso + Berlingo, Ford Grand C-max, Chevrolet Orlando, Mazda 5, Opel Zafira, Peugeot Rifter, Renault Scénic + Grand Scénic, Seat Altea, Toytoa Verso, Volkswagen Golf Sports VAN + Touran + Caddy, BMW 2 Tourer, Mercedes-Benz B + Citan, Fiat Doblo",
            "cena_1_10_dni": 1000,
            "cena_11_30_dni": 800
          },
          {
            "kategorie": "MPV velká",
            "znacka_typ": "Citroën Jumpy + C8, Ford S-MAX + Galaxy, Mercedes-Benz Viano, Peugeot 807, Renault Espace, Seat Alhambra, Volkswagen Sharan, Chrysler Voyager, Peugeot Expert",
            "cena_1_10_dni": 1400,
            "cena_11_30_dni": 1120
          },
          {
            "kategorie": "SUV malé ",
            "znacka_typ": "Baic X3, Dacia Duster + Bigster, SsangYong Tivoli, MG ZS, Citroën C3 Aircross + C4 Aircross + Cactus, DS3 Crossback, Fiat 500X, Ford Ecosport, Honda HRV, Hyundai Bayon + Kona, Jeep Renegade, Kia XCeed + Soul + Stonic + Niro, Mazda CX-3, Mitsubishi ASX, Nissan Juke, Opel Crossland X + Mokka, Peugeot 2008, Renault Captur + Arkana, Seat Arona + Ateca (Cupra), Suzuki Jimny + SX4 + S-Cross + Vitara,  Toyota C-HR + Yaris Cross, Volkswagen Taigo + T-Cross + T-Roc",
            "cena_1_10_dni": 850,
            "cena_11_30_dni": 680
          },
          {
            "kategorie": "SUV malé premium ",
            "znacka_typ": "Mercedes-Benz GLA, Volvo XC40, Baic X5",
            "cena_1_10_dni": 1200,
            "cena_11_30_dni": 960
          },
          {
            "kategorie": "SUV střední ",
            "znacka_typ": "Alfa Romeo Stelvio + Tonale, Baic X7, SsangYong Korando, MG HS + EHS (hybrid), Citroën C-Crosser, Cupra Formentor, DS 7, Fiat Freemont, Ford Edge + Kuga, Honda CR-V, Hyundai ix35 + Tucson, Chevrolet Captiva, Jeep Compass + Cherokee, Kia Sportage + EV3, Mazda CX-5 + CX30, Mitsubishi Eclipse + Outlander, Nissan Quasqai + X-trail, Opel Grandland X, Peugeot 3008 + 5008, Renault Austral + Koleos + Kadjar + Rafale, Seat Tarraco, Subaru Forester + XV, Suzuki Grand Vitara, Toyota RAV4, Volkswagen Tiguan, Jaecoo 7",
            "cena_1_10_dni": 1350,
            "cena_11_30_dni": 1080
          },
          {
            "kategorie": "SUV střední premium",
            "znacka_typ": "Audi Q2 + Q3, BMW X1 + X2, Land Rover Evoque + Defender, Mercedes-Benz ML + GLB, Porsche Macan, Volvo XC60 + XC70, Tesla Model Y, Leapmotor C10",
            "cena_1_10_dni": 1500,
            "cena_11_30_dni": 1200
          },
          {
            "kategorie": "SUV velké ",
            "znacka_typ": "Ford Explorer, Hyundai Santa-Fe, Jeep Wrangler, KIA Sorento, Nissan Pathfinder + Patrol, Mitsubishi Pajero, Nissan X-Trail, Toyota Highlander, SsangYong Rexton, Kia EV6",
            "cena_1_10_dni": 1800,
            "cena_11_30_dni": 1440
          },
          {
            "kategorie": "SUV velké premium",
            "znacka_typ": "Audi Q5, BMW X3 + X4, Jeep Grand Cherokee, Land Rover Discovery + Range Rover Velar, Mercedes-Benz GLC, Volvo XC90, Volkswagen Touareg, Lexus RX, Kia EV9",
            "cena_1_10_dni": 2300,
            "cena_11_30_dni": 1840
          },
          {
            "kategorie": "Luxusní SUV",
            "znacka_typ": "Audi Q7 + Q8, BMW X5 + X6 + X7, Infiniti FX, Land Rover Range Rover, Mercedes-Benz G + GL + GLE + GLS, Porsche Cayenne, Toyota Land Cruiser, Tesla Model X, Hyundai IONIQ 9",
            "cena_1_10_dni": 2750,
            "cena_11_30_dni": 2200
          },
          {
            "kategorie": "Užitková malá",
            "znacka_typ": "Citroën Berlingo + Nemo, Dacia Dokker + Lodgy, Fiat Doblo + Fiorino, Ford Transit Connect, Opel Combo, Peugeot Bipper + Partner + Rifter, Renault Kangoo, Volkswagen Caddy",
            "cena_1_10_dni": 800,
            "cena_11_30_dni": 640
          },
          {
            "kategorie": "Užitková střední",
            "znacka_typ": "Citroën Jumpy, Fiat Talento, Ford Transit Custom, Hyundai H-1 Van, Mercedes-Benz Vito, Nissan NV200, Opel Vivaro, Peugeot Expert, Renault Trafic, Volkswagen Transporter, Kia PV5 Cargo,",
            "cena_1_10_dni": 1000,
            "cena_11_30_dni": 800
          },
          {
            "kategorie": "Užitková velká",
            "znacka_typ": "Citroën Jumper, Fiat Ducato, Ford Transit, Hyundai H350, Iveco Daily, Mercedes-Benz Sprinter, Opel Movano, Peugeot Boxer, Renault Master, Volkswagen Crafter",
            "cena_1_10_dni": 1200,
            "cena_11_30_dni": 960
          },
          {
            "kategorie": "Pick - up",
            "znacka_typ": "Ford Ranger, Isuzu D-Max, Mazda BT, Mitsubishi L200, Mercedes-Benz X, Nissan Navara + NP300, Toyota Hilux, Volkswagen Amarok, Tesla Cybertruck",
            "cena_1_10_dni": 1500,
            "cena_11_30_dni": 1200
          },
          {
            "kategorie": "Mikrobus",
            "znacka_typ": "Citroën Spacetourer + Jumper Bus, Fiat Ducato Minibus, Mercedes-Benz Vito + V, Peugeot Traveller, Volkswagen California + Caravelle + Crafter + Multivan, Hyundai Staria, Toyota Proace Verso, Kia PV5 Passenger",
            "cena_1_10_dni": 1500,
            "cena_11_30_dni": 1200
          }
        ];

        // Vehicle brands list
        const vehicleBrands = [
            'Alfa Romeo', 'Audi', 'Baic', 'BMW', 'Chevrolet', 'Chrysler', 'Citroën', 'Cupra', 
            'Dacia', 'Dodge', 'DS', 'Fiat', 'Ford', 'Honda', 'Hyundai', 'Infiniti', 'Isuzu', 
            'Iveco', 'Jaguar', 'Jaecoo', 'Jeep', 'Kia', 'Land Rover', 'Leapmotor', 'Lexus', 'Maserati', 'Mazda', 
            'Mercedes-Benz', 'MG', 'Mini', 'Mitsubishi', 'Nissan', 'Opel', 'Peugeot', 'Porsche', 
            'Renault', 'Seat', 'Škoda', 'Smart', 'SsangYong', 'Subaru', 'Suzuki', 'Tesla', 
            'Toyota', 'Volkswagen', 'Volvo'
        ];

        // Extract unique models and categories, and create brand-to-models mapping
        function extractBrandsAndModels() {
            const models = new Set();
            const categories = new Set();
            const brandToModels = {}; // Map brand -> Set of models
            const extractedBrands = new Set(); // Track all brands found in data

            // Initialize brand maps with known brands
            vehicleBrands.forEach(brand => {
                brandToModels[brand] = new Set();
            });

            // Helper function to normalize brand name (handle variations like Mercedes-Benz vs Mercedes Benz)
            function normalizeBrand(brandName) {
                // Replace common variations
                return brandName
                    .replace(/-/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();
            }

            // Helper function to find matching brand (case-insensitive, handles variations)
            function findMatchingBrand(part) {
                const partLower = part.toLowerCase();
                
                // Try exact match first
                for (const brand of vehicleBrands) {
                    const brandLower = brand.toLowerCase();
                    const brandNormalized = normalizeBrand(brand).toLowerCase();
                    const partNormalized = normalizeBrand(part).toLowerCase();
                    
                    // Check if part starts with brand name (with space after)
                    if (partLower.startsWith(brandLower + ' ') || 
                        partNormalized.startsWith(brandNormalized + ' ') ||
                        partLower === brandLower) {
                        return brand;
                    }
                }
                
                // If no exact match, try to extract brand from beginning of part
                // Look for known brand patterns at the start
                for (const brand of vehicleBrands) {
                    const brandLower = brand.toLowerCase();
                    const brandWords = brandLower.split(/\s+/);
                    const partWords = partLower.split(/\s+/);
                    
                    // Check if first word(s) match brand
                    let matches = true;
                    for (let i = 0; i < brandWords.length && i < partWords.length; i++) {
                        if (partWords[i] !== brandWords[i]) {
                            matches = false;
                            break;
                        }
                    }
                    
                    if (matches && partWords.length > brandWords.length) {
                        // Check if next word is not a brand (it should be a model)
                        return brand;
                    }
                }
                
                return null;
            }

            cenÝkData.forEach(item => {
                if (item.kategorie) categories.add(item.kategorie);
                
                const znackaTyp = item.znacka_typ;
                
                // Special handling for "vozy Škoda" category
                if (item.kategorie && item.kategorie.toLowerCase().includes('škoda')) {
                    // For Škoda, znacka_typ contains only models (e.g., "Citigo", "Fabia + Roomster", "Octavia I + II", "Octavia III + IV")
                    
                    // First check if the entire string is a version pattern like "Octavia I + II" or "Octavia III + IV"
                    const fullVersionPattern = /^([A-Za-z\s]+)\s+([IVX]+)\s*\+\s*([IVX]+)$/i;
                    const fullVersionMatch = znackaTyp.match(fullVersionPattern);
                    
                    if (fullVersionMatch) {
                        // It's a full version pattern like "Octavia I + II" or "Octavia III + IV"
                        // Extract both versions: "Octavia I" and "Octavia II"
                        const baseModel = fullVersionMatch[1].trim();
                        const version1 = fullVersionMatch[2].trim();
                        const version2 = fullVersionMatch[3].trim();
                        
                        if (baseModel && baseModel.length > 0 && baseModel.length < 30) {
                            // Add both versions
                            const model1 = (baseModel + ' ' + version1).trim();
                            const model2 = (baseModel + ' ' + version2).trim();
                            
                            if (model1.length > 0 && model1.length < 30) {
                                models.add(model1);
                                brandToModels['Škoda'].add(model1);
                            }
                            if (model2.length > 0 && model2.length < 30) {
                                models.add(model2);
                                brandToModels['Škoda'].add(model2);
                            }
                        }
                    } else {
                        // Regular models separated by + (e.g., "Fabia + Roomster", "Scala + Kamiq + Yeti")
                        const skodaModels = znackaTyp.split('+').map(m => m.trim());
                        skodaModels.forEach(model => {
                            if (model && model.length > 0) {
                                // Check if it's a single version like "Octavia II" or "Octavia IV"
                                // Pattern: word(s) followed by space and roman numeral
                                const singleVersionPattern = /^([A-Za-z\s]+)\s+([IVX]+)$/i;
                                const singleVersionMatch = model.match(singleVersionPattern);
                                
                                if (singleVersionMatch) {
                                    // It's a single version like "Octavia II" - keep full name
                                    const fullModel = model.trim();
                                    if (fullModel && fullModel.length > 0 && fullModel.length < 30) {
                                        models.add(fullModel);
                                        brandToModels['Škoda'].add(fullModel);
                                    }
                                } else {
                                    // Regular model name (e.g., "Citigo", "Fabia", "Roomster")
                                    // But skip if it's just a roman numeral (I, II, III, IV, etc.)
                                    const isRomanNumeral = /^[IVX]+$/i.test(model.trim());
                                    if (!isRomanNumeral) {
                                        const cleanModel = model.trim();
                                        if (cleanModel && cleanModel.length > 0 && cleanModel.length < 30) {
                                            models.add(cleanModel);
                                            brandToModels['Škoda'].add(cleanModel);
                                        }
                                    }
                                }
                            }
                        });
                    }
                } else {
                    // For other categories, znacka_typ contains "Brand Model" format
                    // Split by comma to get individual entries (e.g., "Audi Q5, BMW X3 + X4")
                    const parts = znackaTyp.split(',');
                    
                    parts.forEach(part => {
                        part = part.trim();
                        if (!part || part.length === 0) return;
                        
                        // Find matching brand
                        const matchedBrand = findMatchingBrand(part);
                        
                        if (matchedBrand) {
                            extractedBrands.add(matchedBrand);
                            
                            // Initialize brand map if not exists
                            if (!brandToModels[matchedBrand]) {
                                brandToModels[matchedBrand] = new Set();
                            }
                            
                            // Extract models after brand name
                            // Find where brand name ends in the part
                            const brandLower = matchedBrand.toLowerCase();
                            const partLower = part.toLowerCase();
                            let brandEndIndex = matchedBrand.length;
                            
                            // Try to find exact match position
                            if (partLower.startsWith(brandLower + ' ')) {
                                brandEndIndex = matchedBrand.length;
                            } else {
                                // Try normalized match (handle Mercedes-Benz vs Mercedes Benz)
                                const normalizedBrand = normalizeBrand(matchedBrand).toLowerCase();
                                const normalizedPart = normalizeBrand(part).toLowerCase();
                                if (normalizedPart.startsWith(normalizedBrand + ' ')) {
                                    // Find actual position in original string
                                    // Count words in brand and find where they end in part
                                    const brandWords = matchedBrand.split(/\s+/);
                                    const partWords = part.split(/\s+/);
                                    let wordCount = 0;
                                    for (let i = 0; i < brandWords.length && i < partWords.length; i++) {
                                        if (normalizeBrand(partWords[i]).toLowerCase() === normalizeBrand(brandWords[i]).toLowerCase()) {
                                            wordCount++;
                                        } else {
                                            break;
                                        }
                                    }
                                    if (wordCount === brandWords.length) {
                                        // Calculate position after brand words
                                        brandEndIndex = 0;
                                        for (let i = 0; i < wordCount; i++) {
                                            brandEndIndex += partWords[i].length;
                                            if (i < wordCount - 1) brandEndIndex += 1; // space
                                        }
                                    }
                                } else {
                                    // Fallback: try to find brand by matching words
                                    const brandWords = matchedBrand.split(/\s+/);
                                    const partWords = part.split(/\s+/);
                                    let wordCount = 0;
                                    for (let i = 0; i < brandWords.length && i < partWords.length; i++) {
                                        const brandWordNorm = normalizeBrand(brandWords[i]).toLowerCase();
                                        const partWordNorm = normalizeBrand(partWords[i]).toLowerCase();
                                        if (partWordNorm === brandWordNorm) {
                                            wordCount++;
                                        } else {
                                            break;
                                        }
                                    }
                                    if (wordCount === brandWords.length) {
                                        // Calculate position after brand words
                                        brandEndIndex = 0;
                                        for (let i = 0; i < wordCount; i++) {
                                            brandEndIndex += partWords[i].length;
                                            if (i < wordCount - 1) brandEndIndex += 1; // space
                                        }
                                    }
                                }
                            }
                            
                            const afterBrand = part.substring(brandEndIndex).trim();
                            if (afterBrand && afterBrand.length > 0) {
                                // Split by + to get multiple models (e.g., "S60 + V60 + V70" or "X3 + X4")
                                const modelParts = afterBrand.split('+');
                                modelParts.forEach(modelPart => {
                                    modelPart = modelPart.trim();
                                    if (modelPart && modelPart.length > 0 && modelPart.length < 30) {
                                        // Clean model name - remove parentheses content, but keep the model name
                                        let cleanModel = modelPart.replace(/\s*\([^)]*\)/g, '').trim();
                                        // Remove trailing commas
                                        cleanModel = cleanModel.replace(/,\s*$/, '').trim();
                                        if (cleanModel && cleanModel.length > 0) {
                                            models.add(cleanModel);
                                            brandToModels[matchedBrand].add(cleanModel);
                                        }
                                    }
                                });
                            }
                        }
                    });
                }
            });

            // Convert Sets to Arrays and sort
            const brandToModelsArray = {};
            Object.keys(brandToModels).forEach(brand => {
                brandToModelsArray[brand] = Array.from(brandToModels[brand])
                    .filter(m => m.length > 0 && m.length < 30)
                    .sort();
            });

            // Combine extracted brands with known brands, remove duplicates
            const allBrands = Array.from(new Set([...vehicleBrands, ...extractedBrands])).sort();

            return {
                brands: allBrands,
                models: Array.from(models).filter(m => m.length > 0 && m.length < 30).sort(),
                categories: Array.from(categories).sort(),
                brandToModels: brandToModelsArray
            };
        }

        // Autocomplete functionality
        function initAutocomplete(inputId, dropdownId, options, optionsGetter = null) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            let selectedIndex = -1;
            let currentOptions = options;

            // Function to update options dynamically
            function updateOptions(newOptions) {
                currentOptions = newOptions;
            }

            // Store update function on input element for external access
            input.updateAutocompleteOptions = updateOptions;

            function showOptions(filterValue = '') {
                // Use optionsGetter if provided (for dynamic options), otherwise use currentOptions
                const availableOptions = optionsGetter ? optionsGetter() : currentOptions;
                
                const filtered = filterValue 
                    ? availableOptions.filter(option => 
                        option.toLowerCase().startsWith(filterValue.toLowerCase())
                      )
                    : availableOptions;

                if (filtered.length === 0) {
                    dropdown.classList.remove('show');
                    return;
                }

                dropdown.innerHTML = '';
                filtered.forEach((option, index) => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    item.textContent = option;
                    item.addEventListener('click', () => {
                        input.value = option;
                        dropdown.classList.remove('show');
                        input.focus();
                        
                        // Trigger input event to enable model field if this is a brand input
                        const inputEvent = new Event('input', { bubbles: true });
                        input.dispatchEvent(inputEvent);
                    });
                    dropdown.appendChild(item);
                });

                dropdown.classList.add('show');
                selectedIndex = -1;
            }

            // Show all options when input is focused (always show dropdown, even if value exists)
            input.addEventListener('focus', () => {
                // Always show all options when focused, regardless of current value
                showOptions('');
            });

            // Filter options when typing
            input.addEventListener('input', (e) => {
                showOptions(e.target.value);
            });

            input.addEventListener('keydown', (e) => {
                const items = dropdown.querySelectorAll('.autocomplete-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    items.forEach((item, i) => {
                        item.classList.toggle('selected', i === selectedIndex);
                    });
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    items.forEach((item, i) => {
                        item.classList.toggle('selected', i === selectedIndex);
                    });
                } else if (e.key === 'Enter' && selectedIndex >= 0) {
                    e.preventDefault();
                    if (items[selectedIndex]) {
                        input.value = items[selectedIndex].textContent;
                        dropdown.classList.remove('show');
                    }
                } else if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });
        }

        // Generate years list from current year down to 1970
        function generateYears() {
            const currentYear = new Date().getFullYear();
            const years = [];
            for (let year = currentYear; year >= 1970; year--) {
                years.push(year.toString());
            }
            return years;
        }

        // Populate dropdowns
        function populateDropdowns() {
            const { brands, models, categories, brandToModels } = extractBrandsAndModels();
            const years = generateYears();

            // Initialize autocomplete for brand inputs
            initAutocomplete('znackaPoskozene', 'znackaPoskozeneDropdown', brands);
            initAutocomplete('znackaPronajmene', 'znackaPronajmeneDropdown', brands);

            // Initialize autocomplete for model inputs with dynamic options based on selected brand
            const modelPoskozeneInput = document.getElementById('modelPoskozene');
            const modelPronajmeneInput = document.getElementById('modelPronajmene');
            
            // Function to get models for "Poškozené vozidlo" based on selected brand
            function getModelsForPoskozene() {
                const selectedBrand = document.getElementById('znackaPoskozene').value.trim();
                if (!selectedBrand) return [];
                // Try to find matching brand (case-insensitive)
                const matchingBrand = brands.find(b => b.toLowerCase() === selectedBrand.toLowerCase());
                return matchingBrand && brandToModels[matchingBrand] ? brandToModels[matchingBrand] : [];
            }

            // Function to get models for "Pronajímané vozidlo" based on selected brand
            function getModelsForPronajmene() {
                const selectedBrand = document.getElementById('znackaPronajmene').value.trim();
                if (!selectedBrand) return [];
                // Try to find matching brand (case-insensitive)
                const matchingBrand = brands.find(b => b.toLowerCase() === selectedBrand.toLowerCase());
                return matchingBrand && brandToModels[matchingBrand] ? brandToModels[matchingBrand] : [];
            }

            initAutocomplete('modelPoskozene', 'modelPoskozeneDropdown', [], getModelsForPoskozene);
            initAutocomplete('modelPronajmene', 'modelPronajmeneDropdown', [], getModelsForPronajmene);

            // Initialize autocomplete for year input
            initAutocomplete('rokProvozu', 'rokProvozuDropdown', years);
            initAutocomplete('rokProvozuPronajmene', 'rokProvozuPronajmeneDropdown', years);

            // Disable model inputs initially
            modelPoskozeneInput.disabled = true;
            modelPronajmeneInput.disabled = true;

            // Enable model input when brand is selected
            const znackaPoskozene = document.getElementById('znackaPoskozene');
            const znackaPronajmene = document.getElementById('znackaPronajmene');

            // Function to handle brand change for "Poškozené vozidlo"
            function handleBrandChangePoskozene() {
                const brandValue = znackaPoskozene.value.trim();
                const modelDropdown = document.getElementById('modelPoskozeneDropdown');
                
                if (brandValue !== '') {
                    modelPoskozeneInput.disabled = false;
                    modelPoskozeneInput.value = ''; // Clear model when brand changes
                    modelDropdown.classList.remove('show'); // Close model dropdown
                } else {
                    modelPoskozeneInput.disabled = true;
                    modelPoskozeneInput.value = '';
                    modelDropdown.classList.remove('show');
                }
            }

            // Function to handle brand change for "Pronajímané vozidlo"
            function handleBrandChangePronajmene() {
                const brandValue = znackaPronajmene.value.trim();
                const modelDropdown = document.getElementById('modelPronajmeneDropdown');
                
                if (brandValue !== '') {
                    modelPronajmeneInput.disabled = false;
                    modelPronajmeneInput.value = ''; // Clear model when brand changes
                    modelDropdown.classList.remove('show'); // Close model dropdown
                } else {
                    modelPronajmeneInput.disabled = true;
                    modelPronajmeneInput.value = '';
                    modelDropdown.classList.remove('show');
                }
            }

            // Listen for brand selection in "Poškozené vozidlo"
            znackaPoskozene.addEventListener('input', handleBrandChangePoskozene);

            // Listen for brand selection in "Pronajímané vozidlo"
            znackaPronajmene.addEventListener('input', handleBrandChangePronajmene);

            // Also check when autocomplete item is clicked
            const znackaPoskozeneDropdown = document.getElementById('znackaPoskozeneDropdown');
            const znackaPronajmeneDropdown = document.getElementById('znackaPronajmeneDropdown');

            // Add event delegation for brand dropdown clicks
            znackaPoskozeneDropdown.addEventListener('click', function(e) {
                if (e.target.classList.contains('autocomplete-item')) {
                    setTimeout(() => {
                        handleBrandChangePoskozene();
                    }, 50);
                }
            });

            znackaPronajmeneDropdown.addEventListener('click', function(e) {
                if (e.target.classList.contains('autocomplete-item')) {
                    setTimeout(() => {
                        handleBrandChangePronajmene();
                    }, 50);
                }
            });
        }

        // Mapping table for Škoda models to VW equivalents and categories
        const skodaVWMapping = [
            { "skoda": "Škoda Citigo", "vw": "VW Up!", "kategorie": "Mini" },
            { "skoda": "Škoda Fabia", "vw": "VW Polo", "kategorie": "Malá" },
            { "skoda": "Škoda Scala", "vw": "VW Golf", "kategorie": "Nižší střední" },
            { "skoda": "Škoda Octavia", "vw": "VW Golf", "kategorie": "Nižší střední" },
            { "skoda": "Škoda Superb", "vw": "VW Passat", "kategorie": "Střední" },
            { "skoda": "Škoda Karoq", "vw": "VW T-Roc", "kategorie": "SUV malé" },
            { "skoda": "Škoda Kodiaq", "vw": "VW Tiguan", "kategorie": "SUV velké" },
            { "skoda": "Škoda Roomster", "vw": "VW Caddy", "kategorie": "MPV malá" },
            { "skoda": "Škoda Yeti", "vw": "VW T-Roc", "kategorie": "SUV malé" }
        ];

        // Find category by brand and model
        function findCategory(brand, model) {
            if (!brand || !model) return null;
            
            const brandLower = brand.toLowerCase();
            const modelLower = model.toLowerCase();
            
            // Special handling for Škoda - in "vozy Škoda" category, znacka_typ contains only models
            if (brandLower === 'škoda' || brandLower === 'skoda') {
                const item = cenÝkData.find(data => {
                    if (data.kategorie && data.kategorie.toLowerCase().includes('škoda')) {
                        const znackaTyp = data.znacka_typ.toLowerCase();
                        
                        // Check if znacka_typ contains the model
                        // Handle cases like "Octavia I + II", "Octavia III + IV", "Fabia + Roomster"
                        
                        // First check if it's a version pattern like "Octavia I + II" or "Octavia III + IV"
                        const fullVersionPattern = /^([a-z\s]+)\s+([ivx]+)\s*\+\s*([ivx]+)$/i;
                        const fullVersionMatch = znackaTyp.match(fullVersionPattern);
                        
                        if (fullVersionMatch) {
                            // It's a version pattern - check if model matches base name or any version
                            const baseModel = fullVersionMatch[1].trim();
                            const version1 = fullVersionMatch[2].trim();
                            const version2 = fullVersionMatch[3].trim();
                            
                            // Check if model matches base name (e.g., "Octavia" matches "Octavia I + II")
                            if (modelLower === baseModel) {
                                return true;
                            }
                            
                            // Check if model matches base + version1 (e.g., "Octavia I" matches "Octavia I + II")
                            if (modelLower === (baseModel + ' ' + version1).trim()) {
                                return true;
                            }
                            
                            // Check if model matches base + version2 (e.g., "Octavia II" matches "Octavia I + II")
                            if (modelLower === (baseModel + ' ' + version2).trim()) {
                                return true;
                            }
                            
                            // Also check if model contains base name and version (e.g., "Octavia IV" contains "Octavia" and "IV")
                            if (modelLower.includes(baseModel)) {
                                const modelVersion = modelLower.replace(baseModel, '').trim();
                                if (modelVersion === version1 || modelVersion === version2) {
                                    return true;
                                }
                            }
                        } else {
                            // Regular models separated by + (e.g., "Fabia + Roomster", "Scala + Kamiq + Yeti")
                            const models = znackaTyp.split('+').map(m => m.trim().toLowerCase());
                            
                            // Check if any model matches
                            if (models.some(m => {
                                // Direct match
                                if (m === modelLower) return true;
                                // Check if model contains the model name (e.g., "Octavia II" contains "Octavia")
                                if (modelLower.includes(m) || m.includes(modelLower)) return true;
                                // Check if it's a version pattern in the model
                                const singleVersionPattern = /^([a-z\s]+)\s+([ivx]+)$/i;
                                const singleMatch = m.match(singleVersionPattern);
                                if (singleMatch) {
                                    const baseModel = singleMatch[1].trim();
                                    const version = singleMatch[2].trim();
                                    // Check if input model matches base + version
                                    if (modelLower === (baseModel + ' ' + version).trim()) return true;
                                    // Check if input model contains base and version
                                    if (modelLower.includes(baseModel) && modelLower.includes(version)) return true;
                                }
                                return false;
                            })) {
                                return true;
                            }
                        }
                    }
                    return false;
                });
                
                // For Škoda, always return category from ceník (not mapping)
                // Mapping is only used for comparison when rental vehicle is different brand
                if (item && item.kategorie) {
                    return item.kategorie;
                }
                
                return null;
            }
            
            // For other brands, find item where znacka_typ contains both brand and model
            const item = cenÝkData.find(data => {
                const znackaTyp = data.znacka_typ.toLowerCase();
                // Check if znacka_typ contains brand and model
                // Handle cases like "Alfa Romeo Stelvio + Tonale" or "Peugeot 406 + 407 + 508"
                const parts = znackaTyp.split(',');
                
                for (const part of parts) {
                    const partTrimmed = part.trim();
                    // Check if this part contains the brand
                    if (partTrimmed.includes(brandLower)) {
                        // Check if it also contains the model (could be separated by +)
                        const models = partTrimmed.split('+').map(m => m.trim().toLowerCase());
                        // Check if any model matches
                        if (models.some(m => m.includes(modelLower) || modelLower.includes(m.replace(brandLower, '').trim()))) {
                            return true;
                        }
                        // Also check direct match after brand name
                        const afterBrand = partTrimmed.substring(partTrimmed.indexOf(brandLower) + brandLower.length).trim();
                        if (afterBrand.toLowerCase().includes(modelLower)) {
                            return true;
                        }
                    }
                }
                return false;
            });
            
            return item ? item.kategorie : null;
        }

        // Get category hierarchy for downgrading (ordered from lowest to highest)
        const categoryHierarchy = [
            'vozy Škoda',
            'Mini',
            'Malá',
            'Malá ',
            'Malá premium',
            'Nižší střední',
            'Nižší střední premium',
            'Střední',
            'Střední premium',
            'Vyšší střední',
            'Vyšší střední premium',
            'Luxusní',
            'MPV malá',
            'MPV střední',
            'MPV velká',
            'SUV malé',
            'SUV malé ',
            'SUV malé premium',
            'SUV malé premium ',
            'SUV střední',
            'SUV střední ',
            'SUV střední premium',
            'SUV velké',
            'SUV velké ',
            'SUV velké premium',
            'Luxusní SUV',
            'Užitková malá',
            'Užitková střední',
            'Užitková velká',
            'Pick - up',
            'Mikrobus'
        ];

        // Get lower category (one class down within the same vehicle type)
        function getLowerCategory(category) {
            if (!category) return null;
            
            const trimmedCategory = category.trim();
            
            // Category groups ordered from highest to lowest
            const osobniVozy = [
                'Luxusní',
                'Vyšší střední premium',
                'Vyšší střední',
                'Střední premium',
                'Střední',
                'Nižší střední premium',
                'Nižší střední',
                'Malá premium',
                'Malá',
                'Malá ',
                'Mini',
                'vozy Škoda'
            ];
            
            const suv = [
                'Luxusní SUV',
                'SUV velké premium',
                'SUV velké',
                'SUV velké ',
                'SUV střední premium',
                'SUV střední',
                'SUV střední ',
                'SUV malé premium',
                'SUV malé premium ',
                'SUV malé',
                'SUV malé '
            ];
            
            const mpv = [
                'MPV velká',
                'MPV střední',
                'MPV malá'
            ];
            
            const uzitkova = [
                'Užitková velká',
                'Užitková střední',
                'Užitková malá'
            ];
            
            // Special categories that cannot be downgraded
            const special = ['Pick - up', 'Mikrobus'];
            
            // Helper function to find lower category in a group
            function findLowerInGroup(category, group) {
                // Try exact match
                let index = group.indexOf(category);
                if (index === -1) {
                    // Try with trimmed
                    const trimmed = category.trim();
                    for (let i = 0; i < group.length; i++) {
                        if (group[i].trim() === trimmed) {
                            index = i;
                            break;
                        }
                    }
                }
                
                if (index === -1) return null;
                if (index === group.length - 1) return null; // Already at lowest
                return group[index + 1]; // Return next (lower) category
            }
            
            // Check if category is in special group (cannot be downgraded)
            if (special.includes(category) || special.some(s => s.trim() === trimmedCategory)) {
                return null;
            }
            
            // Try to find in osobní vozy group
            let lower = findLowerInGroup(category, osobniVozy);
            if (lower !== null) return lower;
            
            // Try with trimmed for osobní vozy
            for (let i = 0; i < osobniVozy.length; i++) {
                if (osobniVozy[i].trim() === trimmedCategory) {
                    if (i < osobniVozy.length - 1) {
                        return osobniVozy[i + 1];
                    }
                    return null;
                }
            }
            
            // Try to find in SUV group
            lower = findLowerInGroup(category, suv);
            if (lower !== null) return lower;
            
            // Try with trimmed for SUV
            for (let i = 0; i < suv.length; i++) {
                if (suv[i].trim() === trimmedCategory) {
                    if (i < suv.length - 1) {
                        return suv[i + 1];
                    }
                    return null;
                }
            }
            
            // Try to find in MPV group
            lower = findLowerInGroup(category, mpv);
            if (lower !== null) return lower;
            
            // Try with trimmed for MPV
            for (let i = 0; i < mpv.length; i++) {
                if (mpv[i].trim() === trimmedCategory) {
                    if (i < mpv.length - 1) {
                        return mpv[i + 1];
                    }
                    return null;
                }
            }
            
            // Try to find in Užitková group
            lower = findLowerInGroup(category, uzitkova);
            if (lower !== null) return lower;
            
            // Try with trimmed for Užitková
            for (let i = 0; i < uzitkova.length; i++) {
                if (uzitkova[i].trim() === trimmedCategory) {
                    if (i < uzitkova.length - 1) {
                        return uzitkova[i + 1];
                    }
                    return null;
                }
            }
            
            // Category not found in any group, return null
            return null;
        }

        // Compare categories - returns 1 if category1 is higher, -1 if lower, 0 if equal
        function compareCategories(category1, category2) {
            if (!category1 || !category2) return 0;
            
            const index1 = categoryHierarchy.indexOf(category1);
            const index2 = categoryHierarchy.indexOf(category2);
            
            // Try to find with trimmed comparison
            let foundIndex1 = index1;
            let foundIndex2 = index2;
            
            if (foundIndex1 === -1) {
                const trimmed1 = category1.trim();
                for (let i = 0; i < categoryHierarchy.length; i++) {
                    if (categoryHierarchy[i].trim() === trimmed1) {
                        foundIndex1 = i;
                        break;
                    }
                }
            }
            
            if (foundIndex2 === -1) {
                const trimmed2 = category2.trim();
                for (let i = 0; i < categoryHierarchy.length; i++) {
                    if (categoryHierarchy[i].trim() === trimmed2) {
                        foundIndex2 = i;
                        break;
                    }
                }
            }
            
            if (foundIndex1 === -1 || foundIndex2 === -1) return 0;
            
            if (foundIndex1 > foundIndex2) return 1; // category1 is higher
            if (foundIndex1 < foundIndex2) return -1; // category1 is lower
            return 0; // equal
        }

        // Find price by category (optionally with brand and model for "vozy Škoda")
        function findPriceByCategory(category, brand, model) {
            if (!category) return null;
            
            // Special handling for "vozy Škoda" - need to find specific model
            if (category === 'vozy Škoda' && brand && model) {
                const brandLower = brand.toLowerCase();
                const modelLower = model.toLowerCase();
                
                if (brandLower === 'škoda' || brandLower === 'skoda') {
                    const item = cenÝkData.find(data => {
                        if (data.kategorie !== 'vozy Škoda') return false;
                        const znackaTyp = data.znacka_typ.toLowerCase();
                        
                        // Check version patterns like "Octavia I + II"
                        const fullVersionPattern = /^([a-z\s]+)\s+([ivx]+)\s*\+\s*([ivx]+)$/i;
                        const fullVersionMatch = znackaTyp.match(fullVersionPattern);
                        
                        if (fullVersionMatch) {
                            const baseModel = fullVersionMatch[1].trim();
                            const version1 = fullVersionMatch[2].trim();
                            const version2 = fullVersionMatch[3].trim();
                            
                            if (modelLower === baseModel ||
                                modelLower === (baseModel + ' ' + version1).trim() ||
                                modelLower === (baseModel + ' ' + version2).trim()) {
                                return true;
                            }
                            
                            if (modelLower.includes(baseModel)) {
                                const modelVersion = modelLower.replace(baseModel, '').trim();
                                if (modelVersion === version1 || modelVersion === version2) {
                                    return true;
                                }
                            }
                        } else {
                            // Regular models separated by +
                            const models = znackaTyp.split('+').map(m => m.trim().toLowerCase());
                            if (models.some(m => {
                                if (m === modelLower) return true;
                                if (modelLower.includes(m) || m.includes(modelLower)) return true;
                                const singleVersionPattern = /^([a-z\s]+)\s+([ivx]+)$/i;
                                const singleMatch = m.match(singleVersionPattern);
                                if (singleMatch) {
                                    const baseModel = singleMatch[1].trim();
                                    const version = singleMatch[2].trim();
                                    if (modelLower === (baseModel + ' ' + version).trim()) return true;
                                    if (modelLower.includes(baseModel) && modelLower.includes(version)) return true;
                                }
                                return false;
                            })) {
                                return true;
                            }
                        }
                        return false;
                    });
                    
                    if (item) {
                        return {
                            cena_1_10: item.cena_1_10_dni,
                            cena_11_30: item.cena_11_30_dni,
                            kategorie: item.kategorie
                        };
                    }
                }
            }
            
            // Find first item with matching category
            const item = cenÝkData.find(data => data.kategorie === category);
            return item ? {
                cena_1_10: item.cena_1_10_dni,
                cena_11_30: item.cena_11_30_dni,
                kategorie: item.kategorie
            } : null;
        }

        // Calculate
        function calculate() {
            // Get values from form
            const rokProvozu = document.getElementById('rokProvozu').value;
            const znackaPoskozene = document.getElementById('znackaPoskozene').value;
            const modelPoskozene = document.getElementById('modelPoskozene').value;
            const znackaPronajmene = document.getElementById('znackaPronajmene').value;
            const modelPronajmene = document.getElementById('modelPronajmene').value;

            // Validate required fields
            if (!rokProvozu) {
                alert('Prosím vyberte rok uvedení do provozu poškozeného vozidla');
                return;
            }

            if (!modelPronajmene) {
                alert('Prosím vyberte model pronajímaného vozidla');
                return;
            }

            if (!znackaPronajmene) {
                alert('Prosím vyberte značku pronajímaného vozidla');
                return;
            }

            // Find category of rental vehicle
            let rentalCategory = findCategory(znackaPronajmene, modelPronajmene);
            
            if (!rentalCategory) {
                alert('Kategorie pro vybrané pronajímané vozidlo nebyla nalezena. Zkuste vybrat jiný model nebo značku.');
                return;
            }

            // Find category of damaged vehicle (if brand and model are provided)
            let damagedCategory = null;
            let damagedCategoryForComparison = null; // Category for comparison (may use mapping)
            
            if (znackaPoskozene && modelPoskozene) {
                const damagedBrandLower = znackaPoskozene.toLowerCase();
                
                // Check if damaged vehicle is Škoda
                if (damagedBrandLower === 'škoda' || damagedBrandLower === 'skoda') {
                    // For Škoda, get category from ceník (for pricing)
                    damagedCategory = findCategory(znackaPoskozene, modelPoskozene);
                    
                    // But if rental vehicle is different brand, use mapping for comparison
                    const rentalBrandLower = znackaPronajmene.toLowerCase();
                    if (rentalBrandLower !== 'škoda' && rentalBrandLower !== 'skoda') {
                        // Use mapping to get equivalent category for comparison
                        const fullModelName = 'Škoda ' + modelPoskozene;
                        const modelLower = modelPoskozene.toLowerCase();
                        
                        for (const mapping of skodaVWMapping) {
                            const skodaModelLower = mapping.skoda.toLowerCase();
                            
                            // Check exact match
                            if (skodaModelLower === fullModelName.toLowerCase()) {
                                damagedCategoryForComparison = mapping.kategorie;
                                break;
                            }
                            
                            // Check if model name starts with mapped model
                            if (fullModelName.toLowerCase().startsWith(skodaModelLower)) {
                                damagedCategoryForComparison = mapping.kategorie;
                                break;
                            }
                            
                            // Check if mapped model contains the base model
                            const baseModel = modelLower.split(' ')[0];
                            const mappedBaseModel = skodaModelLower.replace('škoda ', '').split(' ')[0];
                            
                            if (baseModel === mappedBaseModel) {
                                damagedCategoryForComparison = mapping.kategorie;
                                break;
                            }
                        }
                    } else {
                        // Both are Škoda, use ceník category for comparison too
                        damagedCategoryForComparison = damagedCategory;
                    }
                } else {
                    // Not Škoda, use normal category finding
                    damagedCategory = findCategory(znackaPoskozene, modelPoskozene);
                    damagedCategoryForComparison = damagedCategory;
                }
            }

            // Determine base category - client has right to same or lower class
            // If rental vehicle is higher class than damaged vehicle, use damaged vehicle category as maximum
            let baseCategory = rentalCategory;
            let useDamagedVehiclePrice = false; // Flag to track if we should use damaged vehicle price
            if (damagedCategoryForComparison) {
                // Special handling: if both are "vozy Škoda", compare by price instead of category
                if (rentalCategory === 'vozy Škoda' && damagedCategoryForComparison === 'vozy Škoda') {
                    // Find prices for both vehicles
                    const rentalPrice = findPriceByCategory(rentalCategory, znackaPronajmene, modelPronajmene);
                    const damagedPrice = findPriceByCategory(damagedCategoryForComparison, znackaPoskozene, modelPoskozene);
                    
                    if (rentalPrice && damagedPrice) {
                        // Compare by price (1-10 days)
                        if (rentalPrice.cena_1_10 > damagedPrice.cena_1_10) {
                            // Rental vehicle is higher class - use damaged vehicle category and price
                            baseCategory = damagedCategory || damagedCategoryForComparison;
                            useDamagedVehiclePrice = true;
                        } else {
                            // Rental vehicle is same or lower class - use rental category
                            baseCategory = rentalCategory;
                            useDamagedVehiclePrice = false;
                        }
                    }
                } else {
                    // Normal category comparison
                    const comparison = compareCategories(rentalCategory, damagedCategoryForComparison);
                    if (comparison > 0) {
                        // Rental vehicle is higher class than damaged vehicle
                        // Client has right only to damaged vehicle category
                        // But use the actual category from ceník for pricing (not the mapped one)
                        baseCategory = damagedCategory || damagedCategoryForComparison;
                        useDamagedVehiclePrice = true;
                    } else {
                        // Rental vehicle is same or lower class - use rental category
                        baseCategory = rentalCategory;
                        useDamagedVehiclePrice = false;
                    }
                }
            }

            // Check if damaged vehicle is older than 8 years
            let finalCategory = baseCategory;
            let finalPriceEntry = null; // For special Škoda downgrade within same category
            const currentYear = new Date().getFullYear();
            const yearOfProduction = parseInt(rokProvozu);
            
            if (isNaN(yearOfProduction)) {
                alert('Neplatný rok uvedení do provozu. Zkuste vybrat rok znovu.');
                return;
            }
            
            if ((currentYear - yearOfProduction) > 8) {
                // Vehicle is older than 8 years, reduce category by one class
                let categoryToDowngrade = baseCategory;
                
                // Special handling for Škoda vehicles
                if (znackaPoskozene && modelPoskozene && baseCategory === 'vozy Škoda') {
                    const damagedBrandLower = znackaPoskozene.toLowerCase();
                    const rentalBrandLower = znackaPronajmene.toLowerCase();
                    
                    if ((damagedBrandLower === 'škoda' || damagedBrandLower === 'skoda') &&
                        (rentalBrandLower === 'škoda' || rentalBrandLower === 'skoda')) {
                        // Both are Škoda - use hierarchy within "vozy Škoda" category
                        // Hierarchy from lowest to highest (by price):
                        // Citigo (500/400) -> Fabia+Roomster (600/480) -> Octavia I+II (600/480) -> 
                        // Rapid (650/520) -> Scala+Kamiq+Yeti (750/600) -> Octavia III+IV (1000/800) ->
                        // Karoq+Elroq (1100/880) -> Superb (1200/960) -> Kodiaq+Enyaq (1350/1080)
                        
                        const skodaHierarchy = [
                            { models: ['citigo'], price: { cena_1_10: 500, cena_11_30: 400 } },
                            { models: ['fabia', 'roomster'], price: { cena_1_10: 600, cena_11_30: 480 } },
                            { models: ['octavia i', 'octavia ii'], price: { cena_1_10: 600, cena_11_30: 480 } },
                            { models: ['rapid'], price: { cena_1_10: 650, cena_11_30: 520 } },
                            { models: ['scala', 'kamiq', 'yeti'], price: { cena_1_10: 750, cena_11_30: 600 } },
                            { models: ['octavia iii', 'octavia iv'], price: { cena_1_10: 1000, cena_11_30: 800 } },
                            { models: ['karoq', 'elroq'], price: { cena_1_10: 1100, cena_11_30: 880 } },
                            { models: ['superb'], price: { cena_1_10: 1200, cena_11_30: 960 } },
                            { models: ['kodiaq', 'enyaq'], price: { cena_1_10: 1350, cena_11_30: 1080 } }
                        ];
                        
                        const modelLower = modelPoskozene.toLowerCase(); // Use damaged vehicle model
                        let currentIndex = -1;
                        
                        // Find current position in hierarchy based on damaged vehicle
                        for (let i = 0; i < skodaHierarchy.length; i++) {
                            if (skodaHierarchy[i].models.some(m => {
                                // Check if model matches (e.g., "octavia ii" matches "octavia ii")
                                if (modelLower === m) return true;
                                // Check if model contains the hierarchy model
                                if (modelLower.includes(m) || m.includes(modelLower)) return true;
                                // For version patterns
                                const baseModel = m.split(' ')[0];
                                const modelBase = modelLower.split(' ')[0];
                                if (baseModel === modelBase) {
                                    // Check if version matches (I, II, III, IV)
                                    const versionPattern = /[ivx]+/i;
                                    const modelVersion = modelLower.match(versionPattern);
                                    const hierarchyVersion = m.match(versionPattern);
                                    if (modelVersion && hierarchyVersion && modelVersion[0] === hierarchyVersion[0]) {
                                        return true;
                                    }
                                }
                                return false;
                            })) {
                                currentIndex = i;
                                break;
                            }
                        }
                        
                        // If found and not at lowest, go one step down
                        if (currentIndex > 0) {
                            const lowerEntry = skodaHierarchy[currentIndex - 1];
                            // Find the actual ceník entry with matching price
                            finalPriceEntry = cenÝkData.find(data => {
                                if (data.kategorie !== 'vozy Škoda') return false;
                                return data.cena_1_10_dni === lowerEntry.price.cena_1_10 &&
                                       data.cena_11_30_dni === lowerEntry.price.cena_11_30;
                            });
                            
                            if (finalPriceEntry) {
                                // Keep "vozy Škoda" category but use the lower price entry
                                finalCategory = 'vozy Škoda';
                            }
                        } else if (currentIndex === 0) {
                            // Already at lowest, can't downgrade further
                            // Keep current category
                        }
                    } else if (damagedBrandLower === 'škoda' || damagedBrandLower === 'skoda') {
                        // Damaged is Škoda but rental is different brand - use mapping
                        const fullModelName = 'Škoda ' + modelPoskozene;
                        const modelLower = modelPoskozene.toLowerCase();
                        
                        for (const mapping of skodaVWMapping) {
                            const skodaModelLower = mapping.skoda.toLowerCase();
                            
                            if (skodaModelLower === fullModelName.toLowerCase() ||
                                fullModelName.toLowerCase().startsWith(skodaModelLower)) {
                                const baseModel = modelLower.split(' ')[0];
                                const mappedBaseModel = skodaModelLower.replace('škoda ', '').split(' ')[0];
                                
                                if (baseModel === mappedBaseModel) {
                                    categoryToDowngrade = mapping.kategorie;
                                    break;
                                }
                            }
                        }
                        
                        const lowerCategory = getLowerCategory(categoryToDowngrade);
                        if (lowerCategory) {
                            finalCategory = lowerCategory;
                        } else if (categoryToDowngrade !== baseCategory) {
                            finalCategory = categoryToDowngrade;
                        }
                    }
                } else {
                    // Not Škoda or not "vozy Škoda" category, use normal downgrade logic
                    const lowerCategory = getLowerCategory(baseCategory);
                    if (lowerCategory) {
                        finalCategory = lowerCategory;
                    }
                }
            }

            // Find price for final category
            // If finalCategory is "vozy Škoda" and we have brand/model, use specific price
            let price = finalPriceEntry;
            if (!price && finalCategory === 'vozy Škoda') {
                // Use the flag to determine which vehicle's price to use
                if (useDamagedVehiclePrice && znackaPoskozene && modelPoskozene) {
                    // Use damaged vehicle price
                    price = findPriceByCategory(finalCategory, znackaPoskozene, modelPoskozene);
                } else if (!useDamagedVehiclePrice && znackaPronajmene && modelPronajmene) {
                    // Use rental vehicle price
                    price = findPriceByCategory(finalCategory, znackaPronajmene, modelPronajmene);
                } else {
                    // Fallback: try both
                    if (znackaPronajmene && modelPronajmene) {
                        price = findPriceByCategory(finalCategory, znackaPronajmene, modelPronajmene);
                    }
                    if (!price && znackaPoskozene && modelPoskozene) {
                        price = findPriceByCategory(finalCategory, znackaPoskozene, modelPoskozene);
                    }
                }
            }
            // If still no price, use generic findPriceByCategory
            if (!price) {
                price = findPriceByCategory(finalCategory);
            }
            
            if (price) {
                const priceText1 = price.cena_1_10.toLocaleString('cs-CZ') + ' Kč bez DPH';
                const priceText2 = price.cena_11_30.toLocaleString('cs-CZ') + ' Kč bez DPH';
                
                // Collect notes if category was adjusted
                const notes = [];
                
                // Check if rental vehicle was higher class than damaged vehicle
                // This applies both for normal category comparison and for Škoda price comparison
                if (useDamagedVehiclePrice || (damagedCategory && compareCategories(rentalCategory, damagedCategory) > 0)) {
                    notes.push('nárok max. podle třídy poškozeného vozidla');
                }
                
                // Check if category was reduced due to age
                if (finalCategory !== baseCategory || finalPriceEntry) {
                    notes.push('sníženo o 1 třídu (poškozené vozidlo je starší 8 let)');
                }
                
                const noteText = notes.length > 0 ? notes.join(', ') : '';
                
                // Set price values
                document.getElementById('cenaDo14').textContent = priceText1;
                document.getElementById('cenaNad14').textContent = priceText2;
                
                // Set notes on separate lines
                document.getElementById('noteDo14').textContent = noteText;
                document.getElementById('noteNad14').textContent = noteText;
                
                const resultsSection = document.getElementById('resultsSection');
                resultsSection.style.display = 'block';
                
                // Add class for print visibility
                resultsSection.classList.add('show-in-print');
                const rentalSection = document.querySelector('.form-section:nth-of-type(3)');
                if (rentalSection) {
                    rentalSection.classList.add('show-in-print');
                }
                
                // Update print date and vehicle info
                const now = new Date();
                const dateStr = now.toLocaleDateString('cs-CZ', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const printDateElement = document.getElementById('printDate');
                if (printDateElement) {
                    printDateElement.textContent = dateStr;
                }
                
                // Update print vehicle info
                const printDamagedYear = document.getElementById('printDamagedYear');
                const printDamagedBrand = document.getElementById('printDamagedBrand');
                const printDamagedModel = document.getElementById('printDamagedModel');
                const printDamagedCategory = document.getElementById('printDamagedCategory');
                const printDamagedCategoryNote = document.getElementById('printDamagedCategoryNote');
                const printRentalDate = document.getElementById('printRentalDate');
                const printRentalBrand = document.getElementById('printRentalBrand');
                const printRentalModel = document.getElementById('printRentalModel');
                
                if (printDamagedYear) printDamagedYear.textContent = document.getElementById('rokProvozu').value || '-';
                if (printDamagedBrand) printDamagedBrand.textContent = document.getElementById('znackaPoskozene').value || '-';
                if (printDamagedModel) printDamagedModel.textContent = document.getElementById('modelPoskozene').value || '-';
                
                // Get damaged category from intermediate step
                const damagedCategoryName = document.getElementById('damagedCategoryName');
                if (printDamagedCategory && damagedCategoryName) {
                    printDamagedCategory.textContent = damagedCategoryName.textContent || '-';
                }
                
                // Get category note if exists
                const damagedCategoryNote = document.getElementById('damagedCategoryNote');
                if (printDamagedCategoryNote && damagedCategoryNote && damagedCategoryNote.textContent) {
                    printDamagedCategoryNote.textContent = damagedCategoryNote.textContent;
                    printDamagedCategoryNote.style.display = 'block';
                } else if (printDamagedCategoryNote) {
                    printDamagedCategoryNote.style.display = 'none';
                }
                
                // Format rental year
                const rentalYearInput = document.getElementById('rokProvozuPronajmene').value;
                if (printRentalDate && rentalYearInput) {
                    printRentalDate.textContent = rentalYearInput;
                } else if (printRentalDate) {
                    printRentalDate.textContent = '-';
                }
                
                if (printRentalBrand) printRentalBrand.textContent = document.getElementById('znackaPronajmene').value || '-';
                if (printRentalModel) printRentalModel.textContent = document.getElementById('modelPronajmene').value || '-';
            } else {
                alert('Cena pro vybranou kategorii nebyla nalezena.');
            }
        }

        // Format brand and model text - make brands bold
        function formatBrandModelText(text) {
            if (!text) return '';
            
            // Helper function to normalize brand name
            function normalizeBrand(brandName) {
                return brandName
                    .replace(/-/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();
            }
            
            // Helper function to find matching brand at the start of text
            function findMatchingBrand(part) {
                const partLower = part.toLowerCase();
                
                // Try exact match first
                for (const brand of vehicleBrands) {
                    const brandLower = brand.toLowerCase();
                    const brandNormalized = normalizeBrand(brand).toLowerCase();
                    const partNormalized = normalizeBrand(part).toLowerCase();
                    
                    // Check if part starts with brand name (with space after)
                    if (partLower.startsWith(brandLower + ' ') || 
                        partNormalized.startsWith(brandNormalized + ' ') ||
                        partLower === brandLower) {
                        return brand;
                    }
                }
                
                // If no exact match, try to extract brand from beginning of part
                for (const brand of vehicleBrands) {
                    const brandLower = brand.toLowerCase();
                    const brandWords = brandLower.split(/\s+/);
                    const partWords = partLower.split(/\s+/);
                    
                    // Check if first word(s) match brand
                    let matches = true;
                    for (let i = 0; i < brandWords.length && i < partWords.length; i++) {
                        if (partWords[i] !== brandWords[i]) {
                            matches = false;
                            break;
                        }
                    }
                    
                    if (matches && partWords.length > brandWords.length) {
                        return brand;
                    }
                }
                
                return null;
            }
            
            // Special handling for "vozy Škoda" - no brand in text, just model names
            // Check if text looks like Škoda models (no brand names, just models like "Citigo", "Fabia + Roomster")
            const isSkodaCategory = !text.includes(',') || 
                (text.split(',').length === 1 && !findMatchingBrand(text));
            
            if (isSkodaCategory) {
                // For Škoda category, just return text as is (no brands to make bold)
                return text;
            }
            
            // Split by comma to get individual entries
            const parts = text.split(',');
            const formattedParts = parts.map(part => {
                part = part.trim();
                if (!part) return '';
                
                const matchedBrand = findMatchingBrand(part);
                if (matchedBrand) {
                    // Find where brand name ends in the original text
                    const brandLower = matchedBrand.toLowerCase();
                    const partLower = part.toLowerCase();
                    const brandNormalized = normalizeBrand(matchedBrand).toLowerCase();
                    const partNormalized = normalizeBrand(part).toLowerCase();
                    
                    let brandEndIndex = -1;
                    
                    // Try to find exact brand match position
                    if (partLower.startsWith(brandLower + ' ')) {
                        brandEndIndex = matchedBrand.length;
                    } else if (partLower.startsWith(brandLower)) {
                        // Brand found but might be followed by model without space
                        brandEndIndex = matchedBrand.length;
                    } else if (partNormalized.startsWith(brandNormalized + ' ')) {
                        // Find position in original text by matching normalized versions
                        // Try different lengths to find where normalized brand ends
                        for (let i = 1; i <= part.length; i++) {
                            const testPart = normalizeBrand(part.substring(0, i)).toLowerCase();
                            if (testPart === brandNormalized) {
                                brandEndIndex = i;
                                break;
                            } else if (testPart.length > brandNormalized.length) {
                                break;
                            }
                        }
                        if (brandEndIndex === -1) {
                            brandEndIndex = matchedBrand.length; // Fallback
                        }
                    } else if (partNormalized.startsWith(brandNormalized)) {
                        // Similar logic for case without space
                        for (let i = 1; i <= part.length; i++) {
                            const testPart = normalizeBrand(part.substring(0, i)).toLowerCase();
                            if (testPart === brandNormalized) {
                                brandEndIndex = i;
                                break;
                            } else if (testPart.length > brandNormalized.length) {
                                break;
                            }
                        }
                        if (brandEndIndex === -1) {
                            brandEndIndex = matchedBrand.length; // Fallback
                        }
                    }
                    
                    if (brandEndIndex === -1) {
                        // Couldn't find exact match, use fallback
                        brandEndIndex = matchedBrand.length;
                    }
                    
                    // Extract model part
                    let modelPart = part.substring(brandEndIndex).trim();
                    
                    // Always add a space between brand and model if model exists
                    if (modelPart) {
                        modelPart = ' ' + modelPart;
                    }
                    
                    // Use normalized brand name (Mercedes-Benz instead of Mercedes Benz)
                    const normalizedBrand = matchedBrand; // Already normalized from vehicleBrands
                    
                    if (modelPart) {
                        return `<strong>${normalizedBrand}</strong>${modelPart}`;
                    } else {
                        return `<strong>${normalizedBrand}</strong>`;
                    }
                }
                
                // If no brand found, return as is
                return part;
            });
            
            return formattedParts.join(', ');
        }

        // Calculate and display damaged vehicle category
        function calculateDamagedVehicleCategory() {
            const rokProvozu = document.getElementById('rokProvozu').value;
            const znackaPoskozene = document.getElementById('znackaPoskozene').value;
            const modelPoskozene = document.getElementById('modelPoskozene').value;
            const section = document.getElementById('damagedVehicleCategorySection');

            // Check if all fields are filled
            if (!rokProvozu || !znackaPoskozene || !modelPoskozene) {
                section.style.display = 'none';
                return;
            }

            // Find category of damaged vehicle
            let damagedCategory = findCategory(znackaPoskozene, modelPoskozene);
            if (!damagedCategory) {
                section.style.display = 'none';
                return;
            }

            // Check if vehicle is older than 8 years
            const currentYear = new Date().getFullYear();
            const yearOfProduction = parseInt(rokProvozu);
            let finalCategory = damagedCategory;
            let categoryNote = '';
            let finalPriceEntry = null;

            if (!isNaN(yearOfProduction) && (currentYear - yearOfProduction) > 8) {
                // Vehicle is older than 8 years, reduce category by one class
                if (damagedCategory === 'vozy Škoda' && znackaPoskozene.toLowerCase() === 'škoda') {
                    // Special handling for Škoda vehicles
                    const skodaHierarchy = [
                        { models: ['citigo'], price: { cena_1_10: 500, cena_11_30: 400 } },
                        { models: ['fabia', 'roomster'], price: { cena_1_10: 600, cena_11_30: 480 } },
                        { models: ['octavia i', 'octavia ii'], price: { cena_1_10: 600, cena_11_30: 480 } },
                        { models: ['rapid'], price: { cena_1_10: 650, cena_11_30: 520 } },
                        { models: ['scala', 'kamiq', 'yeti'], price: { cena_1_10: 750, cena_11_30: 600 } },
                        { models: ['octavia iii', 'octavia iv'], price: { cena_1_10: 1000, cena_11_30: 800 } },
                        { models: ['karoq', 'elroq'], price: { cena_1_10: 1100, cena_11_30: 880 } },
                        { models: ['superb'], price: { cena_1_10: 1200, cena_11_30: 960 } },
                        { models: ['kodiaq', 'enyaq'], price: { cena_1_10: 1350, cena_11_30: 1080 } }
                    ];

                    const modelLower = modelPoskozene.toLowerCase();
                    let currentIndex = -1;

                    for (let i = 0; i < skodaHierarchy.length; i++) {
                        if (skodaHierarchy[i].models.some(m => {
                            if (modelLower === m) return true;
                            if (modelLower.includes(m) || m.includes(modelLower)) return true;
                            const baseModel = m.split(' ')[0];
                            const modelBase = modelLower.split(' ')[0];
                            if (baseModel === modelBase) {
                                const versionPattern = /[ivx]+/i;
                                const modelVersion = modelLower.match(versionPattern);
                                const hierarchyVersion = m.match(versionPattern);
                                if (modelVersion && hierarchyVersion && modelVersion[0] === hierarchyVersion[0]) {
                                    return true;
                                }
                            }
                            return false;
                        })) {
                            currentIndex = i;
                            break;
                        }
                    }

                    if (currentIndex > 0) {
                        const lowerEntry = skodaHierarchy[currentIndex - 1];
                        finalPriceEntry = cenÝkData.find(data => {
                            if (data.kategorie !== 'vozy Škoda') return false;
                            return data.cena_1_10_dni === lowerEntry.price.cena_1_10 &&
                                   data.cena_11_30_dni === lowerEntry.price.cena_11_30;
                        });
                        if (finalPriceEntry) {
                            finalCategory = 'vozy Škoda';
                            categoryNote = 'sníženo o 1 třídu (poškozené vozidlo je starší 8 let)';
                        }
                    }
                } else {
                    // Normal downgrade logic
                    const lowerCategory = getLowerCategory(damagedCategory);
                    if (lowerCategory) {
                        finalCategory = lowerCategory;
                        categoryNote = 'sníženo o 1 třídu (poškozené vozidlo je starší 8 let)';
                    }
                }
            }

            // Get price for final category
            let price = finalPriceEntry;
            if (!price) {
                if (finalCategory === 'vozy Škoda' && znackaPoskozene && modelPoskozene) {
                    price = findPriceByCategory(finalCategory, znackaPoskozene, modelPoskozene);
                } else {
                    price = findPriceByCategory(finalCategory);
                }
            }

            if (!price) {
                section.style.display = 'none';
                return;
            }

            // Normalize price structure (handle both finalPriceEntry and findPriceByCategory return formats)
            const price1_10 = price.cena_1_10 || price.cena_1_10_dni;
            const price11_30 = price.cena_11_30 || price.cena_11_30_dni;

            if (!price1_10 || !price11_30) {
                section.style.display = 'none';
                return;
            }

            // Find equivalent category for Škoda vehicles to display in category name
            let equivalentCategoryName = null;
            if (finalCategory === 'vozy Škoda' && znackaPoskozene && modelPoskozene) {
                const brandLower = znackaPoskozene.toLowerCase();
                const modelLower = modelPoskozene.toLowerCase();
                
                if (brandLower === 'škoda' || brandLower === 'skoda') {
                    const equivalentMapping = skodaVWMapping.find(mapping => {
                        const skodaModelLower = mapping.skoda.toLowerCase();
                        const mappingModelName = skodaModelLower.replace('škoda ', '').trim();
                        const mappingModelBase = mappingModelName.split(' ')[0];
                        const inputModelBase = modelLower.split(' ')[0];
                        
                        if (mappingModelBase === inputModelBase) {
                            return true;
                        }
                        
                        if (mappingModelName.includes(inputModelBase) || inputModelBase.includes(mappingModelBase)) {
                            return true;
                        }
                        
                        if (skodaModelLower.includes(inputModelBase)) {
                            return true;
                        }
                        
                        return false;
                    });
                    
                    if (equivalentMapping && equivalentMapping.kategorie) {
                        equivalentCategoryName = equivalentMapping.kategorie.trim();
                    }
                }
            }

            // Display category name (with equivalent category for Škoda if found)
            let categoryDisplayName = finalCategory;
            if (equivalentCategoryName) {
                categoryDisplayName = finalCategory + ' a ' + equivalentCategoryName;
            }
            const categoryNameElement = document.getElementById('damagedCategoryName');
            categoryNameElement.textContent = categoryDisplayName;
            
            // Display note if category was reduced
            const noteElement = document.getElementById('damagedCategoryNote');
            if (categoryNote) {
                noteElement.textContent = categoryNote;
                noteElement.style.display = 'block';
            } else {
                noteElement.textContent = '';
                noteElement.style.display = 'none';
            }

            // Display rates
            document.getElementById('damagedRate1_10').textContent = price1_10.toLocaleString('cs-CZ') + ' Kč bez DPH';
            document.getElementById('damagedRate11_30').textContent = price11_30.toLocaleString('cs-CZ') + ' Kč bez DPH';

            // Display models in this category
            const modelsBody = document.getElementById('damagedCategoryModelsBody');
            modelsBody.innerHTML = '';
            
            // Special handling for "vozy Škoda" category
            if (finalCategory === 'vozy Škoda' && znackaPoskozene && modelPoskozene) {
                const brandLower = znackaPoskozene.toLowerCase();
                const modelLower = modelPoskozene.toLowerCase();
                
                if (brandLower === 'škoda' || brandLower === 'skoda') {
                    // Find the specific row for this Škoda model
                    const skodaModelRow = cenÝkData.find(data => {
                        if (data.kategorie !== 'vozy Škoda') return false;
                        const znackaTyp = data.znacka_typ.toLowerCase();
                        
                        // Check version patterns like "Octavia I + II"
                        const fullVersionPattern = /^([a-z\s]+)\s+([ivx]+)\s*\+\s*([ivx]+)$/i;
                        const fullVersionMatch = znackaTyp.match(fullVersionPattern);
                        
                        if (fullVersionMatch) {
                            const baseModel = fullVersionMatch[1].trim();
                            const version1 = fullVersionMatch[2].trim();
                            const version2 = fullVersionMatch[3].trim();
                            
                            if (modelLower === baseModel ||
                                modelLower === (baseModel + ' ' + version1).trim() ||
                                modelLower === (baseModel + ' ' + version2).trim()) {
                                return true;
                            }
                            
                            if (modelLower.includes(baseModel)) {
                                const modelVersion = modelLower.replace(baseModel, '').trim();
                                if (modelVersion === version1 || modelVersion === version2) {
                                    return true;
                                }
                            }
                        } else {
                            // Regular models separated by + (e.g., "Fabia + Roomster")
                            const models = znackaTyp.split('+').map(m => m.trim().toLowerCase());
                            
                            if (models.some(m => {
                                if (m === modelLower) return true;
                                if (modelLower.includes(m) || m.includes(modelLower)) return true;
                                const singleVersionPattern = /^([a-z\s]+)\s+([ivx]+)$/i;
                                const singleMatch = m.match(singleVersionPattern);
                                if (singleMatch) {
                                    const baseModel = singleMatch[1].trim();
                                    const version = singleMatch[2].trim();
                                    if (modelLower === (baseModel + ' ' + version).trim()) return true;
                                    if (modelLower.includes(baseModel) && modelLower.includes(version)) return true;
                                }
                                return false;
                            })) {
                                return true;
                            }
                        }
                        return false;
                    });
                    
                    // Display the specific Škoda model row
                    if (skodaModelRow) {
                        const row = document.createElement('tr');
                        const formattedText = formatBrandModelText(skodaModelRow.znacka_typ);
                        row.innerHTML = `
                            <td>${formattedText}</td>
                            <td>${skodaModelRow.cena_1_10_dni.toLocaleString('cs-CZ')} Kč</td>
                            <td>${skodaModelRow.cena_11_30_dni.toLocaleString('cs-CZ')} Kč</td>
                        `;
                        modelsBody.appendChild(row);
                    }
                    
                    // Find equivalent category from mapping table
                    const equivalentMapping = skodaVWMapping.find(mapping => {
                        const skodaModelLower = mapping.skoda.toLowerCase();
                        // Extract model name from mapping (e.g., "škoda fabia" -> "fabia")
                        const mappingModelName = skodaModelLower.replace('škoda ', '').trim();
                        // Extract base model name (first word, e.g., "fabia" or "octavia i" -> "octavia")
                        const mappingModelBase = mappingModelName.split(' ')[0];
                        
                        // Extract base model from input (e.g., "fabia" or "octavia i" -> "fabia" or "octavia")
                        const inputModelBase = modelLower.split(' ')[0];
                        
                        // Direct match of base models
                        if (mappingModelBase === inputModelBase) {
                            return true;
                        }
                        
                        // Check if mapping model name contains input model or vice versa
                        // (e.g., "fabia" matches "fabia", "octavia i" matches "octavia")
                        if (mappingModelName.includes(inputModelBase) || inputModelBase.includes(mappingModelBase)) {
                            return true;
                        }
                        
                        // Also check if full mapping model contains input model
                        // (e.g., "škoda fabia" contains "fabia")
                        if (skodaModelLower.includes(inputModelBase)) {
                            return true;
                        }
                        
                        return false;
                    });
                    
                    // Display all models from equivalent category
                    if (equivalentMapping && equivalentMapping.kategorie) {
                        // Filter by category, ignoring trailing spaces
                        const equivalentCategoryModels = cenÝkData.filter(data => {
                            const dataCategory = (data.kategorie || '').trim();
                            const mappingCategory = (equivalentMapping.kategorie || '').trim();
                            return dataCategory === mappingCategory;
                        });
                        equivalentCategoryModels.forEach(item => {
                            const row = document.createElement('tr');
                            const formattedText = formatBrandModelText(item.znacka_typ);
                            row.innerHTML = `
                                <td>${formattedText}</td>
                                <td>${item.cena_1_10_dni.toLocaleString('cs-CZ')} Kč</td>
                                <td>${item.cena_11_30_dni.toLocaleString('cs-CZ')} Kč</td>
                            `;
                            modelsBody.appendChild(row);
                        });
                    }
                } else {
                    // Not Škoda brand, use normal logic
                    const categoryModels = cenÝkData.filter(data => data.kategorie === finalCategory);
                    categoryModels.forEach(item => {
                        const row = document.createElement('tr');
                        const formattedText = formatBrandModelText(item.znacka_typ);
                        row.innerHTML = `
                            <td>${formattedText}</td>
                            <td>${item.cena_1_10_dni.toLocaleString('cs-CZ')} Kč</td>
                            <td>${item.cena_11_30_dni.toLocaleString('cs-CZ')} Kč</td>
                        `;
                        modelsBody.appendChild(row);
                    });
                }
            } else {
                // Normal category - display all models
                const categoryModels = cenÝkData.filter(data => data.kategorie === finalCategory);
                categoryModels.forEach(item => {
                    const row = document.createElement('tr');
                    const formattedText = formatBrandModelText(item.znacka_typ);
                    row.innerHTML = `
                        <td>${formattedText}</td>
                        <td>${item.cena_1_10_dni.toLocaleString('cs-CZ')} Kč</td>
                        <td>${item.cena_11_30_dni.toLocaleString('cs-CZ')} Kč</td>
                    `;
                    modelsBody.appendChild(row);
                });
            }

            // Show section
            section.style.display = 'block';
            
            // Update print date when category section is shown
            updatePrintDate();
            
            // Update buttons visibility when category section is shown
            updateButtonsVisibility();
        }
        
        // Function to update print date
        function updatePrintDate() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('cs-CZ', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            const printDateElement = document.getElementById('printDate');
            if (printDateElement) {
                printDateElement.textContent = dateStr;
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            populateDropdowns();

            document.getElementById('calculateBtn').addEventListener('click', calculate);
            
            // Function to reset calculation form
            function resetCalculation() {
                // Reset form inputs
                document.getElementById('rokProvozu').value = '';
                document.getElementById('znackaPoskozene').value = '';
                document.getElementById('modelPoskozene').value = '';
                document.getElementById('rokProvozuPronajmene').value = '';
                document.getElementById('znackaPronajmene').value = '';
                document.getElementById('modelPronajmene').value = '';
                
                // Hide results section
                const resultsSection = document.getElementById('resultsSection');
                resultsSection.style.display = 'none';
                resultsSection.classList.remove('show-in-print');
                
                // Remove print class from rental section
                const rentalSection = document.querySelector('.form-section:nth-of-type(3)');
                if (rentalSection) {
                    rentalSection.classList.remove('show-in-print');
                }
                
                // Hide damaged vehicle category section
                document.getElementById('damagedVehicleCategorySection').style.display = 'none';
                
                // Hide buttons
                const actionButtonsContainer = document.getElementById('actionButtonsContainer');
                if (actionButtonsContainer) actionButtonsContainer.style.display = 'none';
                
                // Clear autocomplete dropdowns
                document.querySelectorAll('.autocomplete-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
                
                // Reset model inputs (disable them)
                document.getElementById('modelPoskozene').disabled = true;
                document.getElementById('modelPronajmene').disabled = true;
                
                // Scroll to top of form
                document.querySelector('.main-content').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
             // Make resetCalculation available globally for onclick
             window.resetCalculation = resetCalculation;
            
            // Show/hide buttons based on what is filled
            function updateButtonsVisibility() {
                const rokProvozu = document.getElementById('rokProvozu').value.trim();
                const znackaPoskozene = document.getElementById('znackaPoskozene').value.trim();
                const modelPoskozene = document.getElementById('modelPoskozene').value.trim();
                const rokProvozuPronajmene = document.getElementById('rokProvozuPronajmene').value.trim();
                const znackaPronajmene = document.getElementById('znackaPronajmene').value.trim();
                const modelPronajmene = document.getElementById('modelPronajmene').value.trim();
                const actionButtonsContainer = document.getElementById('actionButtonsContainer');
                const categorySection = document.getElementById('damagedVehicleCategorySection');
                
                // Check if damaged vehicle has required data
                const hasDamagedData = rokProvozu && znackaPoskozene && modelPoskozene;
                
                // Check if rental vehicle has any data filled
                const hasRentalData = rokProvozuPronajmene || znackaPronajmene || modelPronajmene;
                
                // Show buttons if damaged vehicle category is shown OR if any form data is filled
                if (actionButtonsContainer) {
                    if ((categorySection && categorySection.style.display !== 'none') || hasDamagedData || hasRentalData) {
                        actionButtonsContainer.style.display = 'flex';
                        updatePrintDate();
                    } else {
                        actionButtonsContainer.style.display = 'none';
                    }
                }
            }
            
            // Make updateButtonsVisibility available globally
            window.updateButtonsVisibility = updateButtonsVisibility;
            
            // Listen for changes in rental vehicle fields
            const rokProvozuPronajmene = document.getElementById('rokProvozuPronajmene');
            const znackaPronajmene = document.getElementById('znackaPronajmene');
            const modelPronajmene = document.getElementById('modelPronajmene');
            
            rokProvozuPronajmene.addEventListener('input', updateButtonsVisibility);
            rokProvozuPronajmene.addEventListener('change', updateButtonsVisibility);
            znackaPronajmene.addEventListener('input', updateButtonsVisibility);
            znackaPronajmene.addEventListener('change', updateButtonsVisibility);
            modelPronajmene.addEventListener('input', updateButtonsVisibility);
            modelPronajmene.addEventListener('change', updateButtonsVisibility);
            
            // Also check when autocomplete items are selected
            const rokProvozuPronajmeneDropdown = document.getElementById('rokProvozuPronajmeneDropdown');
            const znackaPronajmeneDropdown = document.getElementById('znackaPronajmeneDropdown');
            const modelPronajmeneDropdown = document.getElementById('modelPronajmeneDropdown');
            
            rokProvozuPronajmeneDropdown.addEventListener('click', function(e) {
                if (e.target.classList.contains('autocomplete-item')) {
                    setTimeout(updateButtonsVisibility, 100);
                }
            });
            
            znackaPronajmeneDropdown.addEventListener('click', function(e) {
                if (e.target.classList.contains('autocomplete-item')) {
                    setTimeout(updateButtonsVisibility, 100);
                }
            });
            
            modelPronajmeneDropdown.addEventListener('click', function(e) {
                if (e.target.classList.contains('autocomplete-item')) {
                    setTimeout(updateButtonsVisibility, 100);
                }
            });
            
            // Update print date when results section is shown
            const resultsSection = document.getElementById('resultsSection');
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        if (resultsSection.style.display !== 'none') {
                            updatePrintDate();
                        }
                    }
                });
            });
            observer.observe(resultsSection, { attributes: true, attributeFilter: ['style'] });
            
            // Also update print date when category section is shown
            const categorySection = document.getElementById('damagedVehicleCategorySection');
            const categoryObserver = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        if (categorySection.style.display !== 'none') {
                            updatePrintDate();
                        }
                    }
                });
            });
            categoryObserver.observe(categorySection, { attributes: true, attributeFilter: ['style'] });

            // Add event listeners for damaged vehicle fields
            const rokProvozu = document.getElementById('rokProvozu');
            const znackaPoskozene = document.getElementById('znackaPoskozene');
            const modelPoskozene = document.getElementById('modelPoskozene');

            // Add event listeners for damaged vehicle fields - auto-recalculate on change
            rokProvozu.addEventListener('input', calculateDamagedVehicleCategory);
            rokProvozu.addEventListener('change', calculateDamagedVehicleCategory);
            znackaPoskozene.addEventListener('input', calculateDamagedVehicleCategory);
            znackaPoskozene.addEventListener('change', calculateDamagedVehicleCategory);
            modelPoskozene.addEventListener('input', calculateDamagedVehicleCategory);
            modelPoskozene.addEventListener('change', calculateDamagedVehicleCategory);
            
            // Initial calculation if fields are already filled
            setTimeout(() => {
                calculateDamagedVehicleCategory();
                updateButtonsVisibility();
            }, 100);

            // Also listen for autocomplete selections
            const rokProvozuDropdown = document.getElementById('rokProvozuDropdown');
            const znackaPoskozeneDropdown = document.getElementById('znackaPoskozeneDropdown');
            const modelPoskozeneDropdown = document.getElementById('modelPoskozeneDropdown');

            rokProvozuDropdown.addEventListener('click', function(e) {
                if (e.target.classList.contains('autocomplete-item')) {
                    setTimeout(calculateDamagedVehicleCategory, 100);
                }
            });

            znackaPoskozeneDropdown.addEventListener('click', function(e) {
                if (e.target.classList.contains('autocomplete-item')) {
                    setTimeout(calculateDamagedVehicleCategory, 100);
                }
            });

            modelPoskozeneDropdown.addEventListener('click', function(e) {
                if (e.target.classList.contains('autocomplete-item')) {
                    setTimeout(calculateDamagedVehicleCategory, 100);
                }
            });
        });
    </script>
</body>
</html>

